<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Pentadbir - Sistem Aset Sewaan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS utama (sama seperti sebelumnya) */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #bdc3c7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        /* ... (CSS lain sama seperti sebelumnya) ... */

        /* ===== VACANCY TABLE STYLES ===== */
        .vacancy-section {
            margin-top: 2rem;
            border-top: 1px solid var(--light-gray);
            padding-top: 1.5rem;
        }
        
        .vacancy-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .vacancy-table th {
            background-color: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #ddd;
        }
        
        .vacancy-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .vacancy-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .vacancy-high {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }
        
        .vacancy-medium {
            background-color: rgba(243, 156, 18, 0.15);
            color: #b88b00;
        }
        
        .vacancy-low {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        
        .vacancy-none {
            background-color: rgba(127, 140, 141, 0.15);
            color: var(--gray);
        }
        
        .availability-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
        }
        
        .availability-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .availability-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .stat-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .dot-success { background-color: var(--success); }
        .dot-warning { background-color: var(--warning); }
        .dot-danger { background-color: var(--danger); }
        .dot-gray { background-color: var(--gray); }
    </style>
</head>
<body>
    <!-- ... (HTML utama sama seperti sebelumnya) ... -->

    <!-- View Application Modal (Dikemaskini) -->
    <div class="modal" id="viewApplicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Maklumat Permohonan</h3>
                <button class="close-modal" id="closeViewModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="application-details" id="applicationDetails">
                    <!-- Akan dipopulate oleh JavaScript -->
                </div>
                
                <!-- ===== BAHAGIAN BARU: KETERSEDIAAN ASET ===== -->
                <div class="vacancy-section" id="vacancySection" style="display: none;">
                    <div class="availability-info">
                        <h4><i class="fas fa-map-marker-alt"></i> Ketersediaan Aset untuk <span id="selectedAssetType"></span></h4>
                        <p>Status kekosongan untuk semua lokasi:</p>
                        
                        <div class="availability-stats">
                            <div class="stat-item">
                                <span class="stat-dot dot-success"></span>
                                <span>Banyak Kosong (â‰¥ 5)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-dot dot-warning"></span>
                                <span>Terhad (1-4)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-dot dot-danger"></span>
                                <span>Hampir Penuh (1)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-dot dot-gray"></span>
                                <span>Tiada Kosong</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="vacancy-table" id="vacancyTable">
                            <thead>
                                <tr>
                                    <th>Lokasi</th>
                                    <th>Jumlah Unit</th>
                                    <th>Unit Kosong</th>
                                    <th>Status</th>
                                    <th>Kadar Sewa</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Akan dipopulate oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="approval-form" id="approvalForm">
                    <!-- ... (Sama seperti sebelumnya) ... -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelView">Batal</button>
                <button type="button" class="btn" id="saveDraftBtn" style="background-color: var(--warning); color: white;">Simpan Draft</button>
                <button type="button" class="btn btn-approve" id="submitApproval">Hantar Keputusan</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA STORAGE AND CONSTANTS (Dikemaskini)
        // ============================================
        
        // Storage Keys (Matching User System)
        const USER_DB_KEY = 'asset_rental_users';
        const APPLICATIONS_KEY = 'user_applications';
        const ASSETS_KEY = 'asset_data';
        const ADMIN_KEY = 'admin_data';
        const ADMIN_SESSION_KEY = 'current_admin';
        const VACANCY_KEY = 'asset_vacancy_data'; // Key baru untuk kekosongan
        
        // Data Kekosongan Aset (Contoh)
        const DEFAULT_VACANCY_DATA = {
            // Tanah Lot
            'tanah': [
                { id: 'tanah_1', name: 'Kampung Baru', totalUnits: 20, availableUnits: 15, monthlyRent: 'RM 500' },
                { id: 'tanah_2', name: 'Taman Perdana', totalUnits: 15, availableUnits: 3, monthlyRent: 'RM 800' },
                { id: 'tanah_3', name: 'Desa Jaya', totalUnits: 10, availableUnits: 0, monthlyRent: 'RM 600' },
                { id: 'tanah_4', name: 'Bandar Utama', totalUnits: 25, availableUnits: 10, monthlyRent: 'RM 1,200' }
            ],
            // Rumah Rehat
            'rumah_rehat': [
                { id: 'rr_1', name: 'Rumah Rehat Pantai', totalUnits: 5, availableUnits: 2, monthlyRent: 'RM 1,500' },
                { id: 'rr_2', name: 'Rumah Rehat Hutan', totalUnits: 3, availableUnits: 0, monthlyRent: 'RM 1,200' },
                { id: 'rr_3', name: 'Rumah Rehat Bukit', totalUnits: 4, availableUnits: 1, monthlyRent: 'RM 1,800' }
            ],
            // Lot Kedai
            'kedai': [
                { id: 'kedai_1', name: 'Kompleks Perniagaan', totalUnits: 30, availableUnits: 8, monthlyRent: 'RM 2,500' },
                { id: 'kedai_2', name: 'Pasaraya Besar', totalUnits: 20, availableUnits: 2, monthlyRent: 'RM 3,000' },
                { id: 'kedai_3', name: 'Pusat Bandar', totalUnits: 15, availableUnits: 0, monthlyRent: 'RM 4,000' }
            ],
            // Bilik Sejuk
            'bilik': [
                { id: 'bilik_1', name: 'Bangunan A', totalUnits: 10, availableUnits: 5, monthlyRent: 'RM 800' },
                { id: 'bilik_2', name: 'Bangunan B', totalUnits: 8, availableUnits: 1, monthlyRent: 'RM 750' }
            ],
            // Jenis aset lain...
            'slipway': [
                { id: 'slip_1', name: 'Jeti Utama', totalUnits: 5, availableUnits: 2, monthlyRent: 'RM 5,000' }
            ],
            'pphp': [
                { id: 'pphp_1', name: 'PPHP Pusat', totalUnits: 3, availableUnits: 1, monthlyRent: 'RM 3,500' }
            ]
        };
        
        // Global Variables
        let currentAdmin = null;
        let applications = [];
        let users = [];
        let assets = [];
        let vacancyData = {}; // Data kekosongan
        let currentApplicationId = null;
        let currentUserId = null;
        let currentAssetId = null;
        
        // ============================================
        // INITIALIZATION (Dikemaskini)
        // ============================================
        
        function initializeAdminSystem() {
            // Load data dari localStorage
            loadApplications();
            loadUsers();
            loadAssets();
            loadVacancyData();
            
            // Initialize admin account jika belum ada
            const storedAdmin = localStorage.getItem(ADMIN_KEY);
            if (!storedAdmin) {
                localStorage.setItem(ADMIN_KEY, JSON.stringify(ADMIN_CREDENTIALS));
            }
        }
        
        function loadVacancyData() {
            const storedVacancy = localStorage.getItem(VACANCY_KEY);
            if (storedVacancy) {
                vacancyData = JSON.parse(storedVacancy);
            } else {
                // Gunakan data default jika tiada dalam storage
                vacancyData = DEFAULT_VACANCY_DATA;
                localStorage.setItem(VACANCY_KEY, JSON.stringify(vacancyData));
            }
        }
        
        // ============================================
        // VIEW APPLICATION (Dikemaskini dengan Vacancy)
        // ============================================
        
        function viewApplication(appId) {
            const application = applications.find(app => app.id == appId);
            if (!application) return;
            
            currentApplicationId = appId;
            
            // Populate application details
            const detailsContainer = document.getElementById('applicationDetails');
            detailsContainer.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">No. Rujukan:</span>
                    <span class="detail-value">${application.reference}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Nama Pemohon:</span>
                    <span class="detail-value">${application.applicantName}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">No. Kad Pengenalan:</span>
                    <span class="detail-value">${formatIC(application.applicantIC || '')}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${application.applicantEmail || 'Tiada'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Telefon:</span>
                    <span class="detail-value">${formatPhone(application.applicantPhone || '')}</span>
                </div>
                <div class="detail-item" style="grid-column: span 2;">
                    <span class="detail-label">Jenis Aset:</span>
                    <span class="detail-value">${application.assetName} - ${application.location}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Tarikh Mohon:</span>
                    <span class="detail-value">${formatDate(application.applyDate)}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status Semasa:</span>
                    <span class="detail-value">
                        <span class="status-badge status-${application.status}">
                            ${application.statusText || application.status}
                        </span>
                    </span>
                </div>
                <div class="detail-item" style="grid-column: span 2;">
                    <span class="detail-label">Tujuan Permohonan:</span>
                    <span class="detail-value">${application.purpose || 'Tiada maklumat'}</span>
                </div>
                ${application.approvalNotes ? `
                <div class="detail-item" style="grid-column: span 2;">
                    <span class="detail-label">Catatan Kelulusan:</span>
                    <span class="detail-value">${application.approvalNotes}</span>
                </div>
                ` : ''}
            `;
            
            // TUNJUKKAN KETERSEDIAAN ASET jika ada jenis aset
            if (application.assetType) {
                showAssetVacancy(application.assetType, application.assetName);
            }
            
            // Set current status dalam dropdown
            document.getElementById('approvalStatus').value = application.status;
            document.getElementById('approvalNotes').value = application.approvalNotes || '';
            
            // Show modal
            document.getElementById('viewApplicationModal').style.display = 'flex';
        }
        
        function showAssetVacancy(assetType, assetName) {
            const vacancySection = document.getElementById('vacancySection');
            const vacancyTable = document.querySelector('#vacancyTable tbody');
            
            // Dapatkan data kekosongan untuk jenis aset ini
            const typeVacancy = vacancyData[assetType] || [];
            
            if (typeVacancy.length === 0) {
                vacancySection.style.display = 'none';
                return;
            }
            
            // Tunjukkan bahagian vacancy
            vacancySection.style.display = 'block';
            document.getElementById('selectedAssetType').textContent = getAssetTypeText(assetType);
            
            // Kosongkan table
            vacancyTable.innerHTML = '';
            
            // Populate table dengan data kekosongan
            typeVacancy.forEach(location => {
                const row = document.createElement('tr');
                
                // Tentukan status badge berdasarkan kekosongan
                let statusClass, statusText;
                if (location.availableUnits === 0) {
                    statusClass = 'vacancy-none';
                    statusText = 'Tiada Kosong';
                } else if (location.availableUnits === 1) {
                    statusClass = 'vacancy-low';
                    statusText = 'Hampir Penuh';
                } else if (location.availableUnits <= 4) {
                    statusClass = 'vacancy-medium';
                    statusText = 'Terhad';
                } else {
                    statusClass = 'vacancy-high';
                    statusText = 'Banyak Kosong';
                }
                
                // Highlight row jika ini lokasi yang dipilih oleh pemohon
                const isSelectedLocation = location.name === assetName;
                const rowStyle = isSelectedLocation ? 'background-color: rgba(52, 152, 219, 0.1); border-left: 3px solid var(--secondary);' : '';
                
                row.innerHTML = `
                    <td style="${rowStyle}">
                        ${location.name}
                        ${isSelectedLocation ? '<i class="fas fa-map-pin" style="color: var(--secondary); margin-left: 5px;"></i>' : ''}
                    </td>
                    <td>${location.totalUnits}</td>
                    <td><strong>${location.availableUnits}</strong></td>
                    <td><span class="vacancy-badge ${statusClass}">${statusText}</span></td>
                    <td>${location.monthlyRent || 'RM -'}</td>
                `;
                vacancyTable.appendChild(row);
            });
        }
        
        // ============================================
        // ASSET MANAGEMENT (Dikemaskini dengan Vacancy)
        // ============================================
        
        function editAsset(assetId) {
            const asset = assets.find(a => a.id == assetId);
            if (!asset) return;
            
            currentAssetId = assetId;
            
            // Populate form
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type;
            document.getElementById('assetLocation').value = asset.location;
            document.getElementById('totalUnits').value = asset.totalUnits;
            document.getElementById('availableUnits').value = asset.availableUnits;
            document.getElementById('monthlyRent').value = asset.monthlyRent?.replace('RM ', '') || '';
            document.getElementById('assetStatus').value = getAssetStatusValue(asset.availableUnits, asset.totalUnits);
            document.getElementById('assetDescription').value = asset.description || '';
            
            // Enable location dropdown based on asset type
            updateLocationDropdown(asset.type);
            
            // Show modal
            document.getElementById('assetModal').style.display = 'flex';
        }
        
        function updateLocationDropdown(assetType) {
            const locationSelect = document.getElementById('assetLocation');
            const vacancyLocations = vacancyData[assetType] || [];
            
            // Clear existing options
            locationSelect.innerHTML = '<option value="" selected disabled>Sila pilih lokasi</option>';
            
            // Add options from vacancy data
            vacancyLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.name;
                option.textContent = `${location.name} (${location.availableUnits} kosong dari ${location.totalUnits})`;
                
                // Color code based on availability
                if (location.availableUnits === 0) {
                    option.style.color = '#dc3545'; // red
                    option.style.fontWeight = 'bold';
                } else if (location.availableUnits <= 2) {
                    option.style.color = '#ffc107'; // yellow
                } else {
                    option.style.color = '#28a745'; // green
                }
                
                locationSelect.appendChild(option);
            });
            
            // Enable the select
            locationSelect.disabled = false;
        }
        
        // ============================================
        // UTILITY FUNCTIONS TAMBAHAN
        // ============================================
        
        function updateVacancyData(assetType, locationName, change = -1) {
            // Update vacancy data when an application is approved
            if (vacancyData[assetType]) {
                const locationIndex = vacancyData[assetType].findIndex(loc => loc.name === locationName);
                if (locationIndex !== -1 && vacancyData[assetType][locationIndex].availableUnits > 0) {
                    vacancyData[assetType][locationIndex].availableUnits += change;
                    localStorage.setItem(VACANCY_KEY, JSON.stringify(vacancyData));
                }
            }
        }
        
        function getAssetTypeText(type) {
            const types = {
                'tanah': 'Tanah Lot',
                'rumah_rehat': 'Rumah Rehat',
                'kedai': 'Lot Kedai',
                'bilik': 'Bilik Sejuk',
                'slipway': 'Slipway',
                'pphp': 'PPHP',
                'kompleks': 'Kompleks',
                'pasar': 'Pasar Nelayan',
                'akuakultur': 'Akuakultur',
                'ccdc': 'CCDC',
                'jeti': 'Jeti',
                'kuarters': 'Kuarters',
                'pejabat': 'Pejabat'
            };
            return types[type] || type;
        }
        
        // ============================================
        // UPDATE PROCESS APPLICATION FUNCTION
        // ============================================
        
        function processApplication(appId, status, statusText) {
            const application = applications.find(app => app.id == appId);
            if (!application) return;
            
            // Update application
            application.status = status;
            application.statusText = statusText;
            application.processedDate = new Date().toISOString().split('T')[0];
            application.processedBy = currentAdmin.name;
            
            // Update asset availability if approved
            if (status === 'approved') {
                // Update vacancy data
                updateVacancyData(application.assetType, application.assetName, -1);
                
                // Update assets data
                const asset = assets.find(a => a.type === application.assetType);
                if (asset && asset.availableUnits > 0) {
                    asset.availableUnits -= 1;
                    localStorage.setItem(ASSETS_KEY, JSON.stringify(assets));
                }
            }
            
            // Save to localStorage
            localStorage.setItem(APPLICATIONS_KEY, JSON.stringify(applications));
            
            // Update UI
            updateDashboardCounters();
            renderNewApplications();
            renderProcessedApplications();
            renderRecentApplications();
            renderAssets();
            
            // Show notification
            showNotification(`Permohonan ${status === 'approved' ? 'diluluskan' : 'ditolak'}!`, 'success');
            
            // Close modal jika terbuka
            closeModal('viewApplicationModal');
        }
        
        // ============================================
        // UPDATE EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // ... (event listeners lain sama seperti sebelumnya) ...
            
            // Update asset type change listener untuk location dropdown
            document.getElementById('assetType').addEventListener('change', function() {
                updateLocationDropdown(this.value);
            });
        }
        
        // ============================================
        // INITIALIZATION ON LOAD
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminSystem();
            setupEventListeners();
            checkAdminLoginStatus();
            startRealTimeSync();
        });
        
    </script>
</body>
</html>
