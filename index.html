<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Aset Sewaan - Portal Lengkap</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS styles remain the same) ... */
    </style>
</head>
<body>
    <!-- ... (HTML structure remains the same until navigation section) ... -->
    
    <!-- Navigation -->
    <nav class="app-nav" id="appNav">
        <div class="container nav-container">
            <ul class="nav-links" id="navLinks">
                <!-- Navigation links will be loaded here based on user type -->
            </ul>
            
            <div class="quick-actions">
                <!-- This button will only show for regular users -->
                <button class="btn btn-primary" id="newApplicationBtn" style="display: none;">
                    <i class="fas fa-plus"></i> Mohon Baru
                </button>
            </div>
        </div>
    </nav>
    
    <!-- ... (Rest of HTML remains the same) ... -->

    <script>
        // ============================================
        // DATA STORAGE AND INITIALIZATION
        // ============================================
        
        const STORAGE_KEYS = {
            USERS: 'asset_rental_users',
            CURRENT_USER: 'current_asset_user',
            APPLICATIONS: 'user_applications',
            ASSETS: 'asset_data',
            VACANCIES: 'asset_vacancies',
            PASSWORD_RESET_TOKENS: 'password_reset_tokens'
        };
        
        // ... (Data declarations remain the same) ...
        
        let currentUser = null;
        let users = [];
        let applications = [];
        let assets = [];
        let vacancies = VACANCY_DATA;
        let passwordResetTokens = {};
        let isEditingProfile = false;
        
        // Initialize System
        function initializeSystem() {
            // ... (initialization code remains the same) ...
        }
        
        // ... (Authentication functions remain the same) ...
        
        // ============================================
        // PROFILE EDIT FUNCTIONS - FIXED VERSION
        // ============================================
        
        function startProfileEdit() {
            console.log("startProfileEdit called"); // Debug log
            
            isEditingProfile = true;
            
            // Add editing class to profile card
            const profileCard = document.getElementById('profileCard');
            if (profileCard) {
                profileCard.classList.add('editing');
            }
            
            // Show edit buttons, hide edit button
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (editBtn) editBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
            
            // Load current user data into edit fields
            const user = users.find(u => u.id === currentUser.id);
            if (user) {
                const editName = document.getElementById('editName');
                const editIC = document.getElementById('editIC');
                const editPhone = document.getElementById('editPhone');
                const editEmail = document.getElementById('editEmail');
                const editAddress = document.getElementById('editAddress');
                
                if (editName) editName.value = user.name;
                if (editIC) editIC.value = user.ic;
                if (editPhone) editPhone.value = user.phone || '';
                if (editEmail) editEmail.value = user.email;
                if (editAddress) editAddress.value = user.address || '';
            }
        }
        
        function cancelProfileEdit() {
            console.log("cancelProfileEdit called"); // Debug log
            
            isEditingProfile = false;
            
            // Remove editing class
            const profileCard = document.getElementById('profileCard');
            if (profileCard) {
                profileCard.classList.remove('editing');
            }
            
            // Show edit button, hide edit buttons
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (editBtn) editBtn.style.display = 'inline-flex';
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            // Clear validation messages
            clearValidationMessages();
        }
        
        function saveProfileChanges() {
            console.log("saveProfileChanges called"); // Debug log
            
            // Clear previous errors
            clearValidationMessages();
            
            const nameInput = document.getElementById('editName');
            const phoneInput = document.getElementById('editPhone');
            const emailInput = document.getElementById('editEmail');
            const addressInput = document.getElementById('editAddress');
            
            if (!nameInput || !emailInput) {
                alert('Ralat: Borang tidak lengkap');
                return;
            }
            
            const name = nameInput.value.trim();
            const phone = phoneInput ? phoneInput.value.trim() : '';
            const email = emailInput.value.trim();
            const address = addressInput ? addressInput.value.trim() : '';
            
            // Validation
            if (!name) {
                alert('Sila isi nama penuh');
                return;
            }
            
            if (!validateEmail(email)) {
                alert('Format email tidak sah');
                return;
            }
            
            // Check if email is already taken by another user
            const existingUser = users.find(u => u.email === email && u.id !== currentUser.id);
            if (existingUser) {
                alert('Email ini sudah digunakan oleh pengguna lain');
                return;
            }
            
            // Find and update user
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].phone = phone;
                users[userIndex].email = email;
                users[userIndex].address = address;
                
                // Update current user data
                currentUser.name = name;
                currentUser.phone = phone;
                currentUser.email = email;
                currentUser.address = address;
                
                // Save to storage
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                sessionStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                
                // Update UI
                updateUserInterface();
                loadUserDashboard();
                
                // Exit edit mode
                cancelProfileEdit();
                
                // Show success message
                alert('Profil anda telah berjaya dikemaskini!');
            } else {
                alert('Ralat: Pengguna tidak ditemui');
            }
        }
        
        // ============================================
        // DASHBOARD AND NAVIGATION FUNCTIONS
        // ============================================
        
        function loadDashboard() {
            if (currentUser.role === 'admin') {
                const userDashboard = document.getElementById('userDashboard');
                const adminDashboard = document.getElementById('adminDashboard');
                
                if (userDashboard) userDashboard.style.display = 'none';
                if (adminDashboard) adminDashboard.style.display = 'block';
                
                loadAdminDashboard();
            } else {
                const userDashboard = document.getElementById('userDashboard');
                const adminDashboard = document.getElementById('adminDashboard');
                
                if (userDashboard) userDashboard.style.display = 'block';
                if (adminDashboard) adminDashboard.style.display = 'none';
                
                loadUserDashboard();
            }
        }
        
        // ... (Other functions remain the same) ...
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update header
            const headerUserName = document.getElementById('headerUserName');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (headerUserName) headerUserName.textContent = currentUser.name;
            if (userAvatar) userAvatar.textContent = getInitials(currentUser.name);
            if (userName) userName.textContent = currentUser.name;
            
            // Update welcome message
            const welcomeTitle = document.getElementById('welcomeTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `Selamat Datang, ${currentUser.name.split(' ')[0]}!`;
            }
            
            // Update navigation based on role
            updateNavigation();
        }
        
        function updateNavigation() {
            const navLinks = document.getElementById('navLinks');
            const newApplicationBtn = document.getElementById('newApplicationBtn');
            
            if (!navLinks) return;
            
            navLinks.innerHTML = '';
            
            const links = [
                { page: 'dashboard', icon: 'fas fa-home', text: 'Dashboard' }
            ];
            
            if (currentUser.role === 'admin') {
                links.push(
                    { page: 'users', icon: 'fas fa-users', text: 'Pengguna' },
                    { page: 'application', icon: 'fas fa-file-alt', text: 'Semua Permohonan' }
                );
                
                // Hide "Mohon Baru" button for admin
                if (newApplicationBtn) {
                    newApplicationBtn.style.display = 'none';
                }
            } else {
                links.push(
                    { page: 'assets', icon: 'fas fa-building', text: 'Aset Tersedia' },
                    { page: 'application', icon: 'fas fa-file-alt', text: 'Permohonan Saya' },
                    { page: 'profile', icon: 'fas fa-user', text: 'Profil Saya' }
                );
                
                // Show "Mohon Baru" button for regular users
                if (newApplicationBtn) {
                    newApplicationBtn.style.display = 'block';
                }
            }
            
            links.forEach(link => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="${link.page === 'dashboard' ? 'active' : ''}" data-page="${link.page}">
                        <i class="${link.icon}"></i> ${link.text}
                    </a>
                `;
                navLinks.appendChild(li);
            });
            
            // Update header style for admin
            const appHeader = document.getElementById('appHeader');
            const appNav = document.getElementById('appNav');
            
            if (appHeader && appNav) {
                if (currentUser.role === 'admin') {
                    appHeader.classList.add('admin-header');
                    appNav.classList.add('admin-nav');
                } else {
                    appHeader.classList.remove('admin-header');
                    appNav.classList.remove('admin-nav');
                }
            }
        }
        
        // ============================================
        // APPLICATION FUNCTIONS - FIXED
        // ============================================
        
        function openApplicationModal(assetType = null) {
            console.log("openApplicationModal called"); // Debug log
            
            const modal = document.getElementById('applicationModal');
            if (!modal) {
                alert('Ralat: Modal tidak ditemui');
                return;
            }
            
            modal.style.display = 'flex';
            
            // Reset location selector
            resetLocationSelector();
            
            // Auto-fill user data from profile
            if (currentUser) {
                const user = users.find(u => u.id === currentUser.id);
                if (user) {
                    // Automatically fill name, IC, and email from profile
                    const applicantName = document.getElementById('applicantName');
                    const applicantIC = document.getElementById('applicantIC');
                    const applicantEmail = document.getElementById('applicantEmail');
                    const applicantPhone = document.getElementById('applicantPhone');
                    const applicantAddress = document.getElementById('applicantAddress');
                    
                    if (applicantName) applicantName.value = user.name;
                    if (applicantIC) applicantIC.value = user.ic;
                    if (applicantEmail) applicantEmail.value = user.email;
                    if (applicantPhone) applicantPhone.value = user.phone || '';
                    if (applicantAddress) applicantAddress.value = user.address || '';
                }
            }
            
            // Set asset type if provided
            if (assetType) {
                const assetTypeSelect = document.getElementById('assetType');
                if (assetTypeSelect) {
                    assetTypeSelect.value = assetType;
                    // Trigger change to load locations
                    setTimeout(() => {
                        loadLocationsForAssetType(assetType);
                    }, 100);
                }
            }
            
            // Set default date (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const startDate = document.getElementById('startDate');
            if (startDate) {
                startDate.value = tomorrow.toISOString().split('T')[0];
            }
            
            // Reset form except auto-filled fields
            const purpose = document.getElementById('purpose');
            const additionalInfo = document.getElementById('additionalInfo');
            const agreeTermsModal = document.getElementById('agreeTermsModal');
            
            if (purpose) purpose.value = '';
            if (additionalInfo) additionalInfo.value = '';
            if (agreeTermsModal) agreeTermsModal.checked = false;
        }
        
        // ============================================
        // EVENT LISTENERS SETUP - FIXED VERSION
        // ============================================
        
        function setupEventListeners() {
            console.log("Setting up event listeners..."); // Debug log
            
            // Authentication tabs
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const goToRegister = document.getElementById('goToRegister');
            const goToLogin = document.getElementById('goToLogin');
            const goToLoginFromSuccess = document.getElementById('goToLoginFromSuccess');
            const goToLoginFromResetSuccess = document.getElementById('goToLoginFromResetSuccess');
            
            if (loginTab) loginTab.addEventListener('click', () => switchAuthTab('login'));
            if (registerTab) registerTab.addEventListener('click', () => switchAuthTab('register'));
            if (goToRegister) goToRegister.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('register');
            });
            if (goToLogin) goToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            if (goToLoginFromSuccess) goToLoginFromSuccess.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            if (goToLoginFromResetSuccess) goToLoginFromResetSuccess.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            // Forgot password links
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const backToLogin = document.getElementById('backToLogin');
            const backToLoginFromReset = document.getElementById('backToLoginFromReset');
            
            if (forgotPasswordLink) forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('forgotPassword');
            });
            
            if (backToLogin) backToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            if (backToLoginFromReset) backToLoginFromReset.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            // Form submissions
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const changePasswordForm = document.getElementById('changePasswordForm');
            const rentalApplicationForm = document.getElementById('rentalApplicationForm');
            
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (registerForm) registerForm.addEventListener('submit', handleRegister);
            if (forgotPasswordForm) forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            if (resetPasswordForm) resetPasswordForm.addEventListener('submit', handleResetPassword);
            if (changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
            if (rentalApplicationForm) rentalApplicationForm.addEventListener('submit', submitApplication);
            
            // Password toggles
            const toggleLoginPassword = document.getElementById('toggleLoginPassword');
            const toggleNewPassword = document.getElementById('toggleNewPassword');
            const toggleConfirmNewPassword = document.getElementById('toggleConfirmNewPassword');
            const toggleCurrentPassword = document.getElementById('toggleCurrentPassword');
            const toggleNewPasswordProfile = document.getElementById('toggleNewPasswordProfile');
            const toggleConfirmNewPasswordProfile = document.getElementById('toggleConfirmNewPasswordProfile');
            
            if (toggleLoginPassword) toggleLoginPassword.addEventListener('click', () => togglePasswordVisibility('loginPassword', 'toggleLoginPassword'));
            if (toggleNewPassword) toggleNewPassword.addEventListener('click', () => togglePasswordVisibility('newPassword', 'toggleNewPassword'));
            if (toggleConfirmNewPassword) toggleConfirmNewPassword.addEventListener('click', () => togglePasswordVisibility('confirmNewPassword', 'toggleConfirmNewPassword'));
            if (toggleCurrentPassword) toggleCurrentPassword.addEventListener('click', () => togglePasswordVisibility('currentPassword', 'toggleCurrentPassword'));
            if (toggleNewPasswordProfile) toggleNewPasswordProfile.addEventListener('click', () => togglePasswordVisibility('newPasswordProfile', 'toggleNewPasswordProfile'));
            if (toggleConfirmNewPasswordProfile) toggleConfirmNewPasswordProfile.addEventListener('click', () => togglePasswordVisibility('confirmNewPasswordProfile', 'toggleConfirmNewPasswordProfile'));
            
            // Profile edit buttons - FIXED
            const editProfileBtn = document.getElementById('editProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            console.log("Edit Profile Button:", editProfileBtn); // Debug log
            console.log("Save Profile Button:", saveProfileBtn); // Debug log
            console.log("Cancel Edit Button:", cancelEditBtn); // Debug log
            
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function(e) {
                    console.log("Edit profile button clicked!"); // Debug log
                    e.preventDefault();
                    startProfileEdit();
                });
            }
            
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', function(e) {
                    console.log("Save profile button clicked!"); // Debug log
                    e.preventDefault();
                    saveProfileChanges();
                });
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function(e) {
                    console.log("Cancel edit button clicked!"); // Debug log
                    e.preventDefault();
                    cancelProfileEdit();
                });
            }
            
            // Change password button
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', () => {
                    const modal = document.getElementById('changePasswordModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                });
            }
            
            // Modal close buttons
            const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');
            const cancelChangePassword = document.getElementById('cancelChangePassword');
            
            if (closeChangePasswordModal) closeChangePasswordModal.addEventListener('click', () => closeModal('changePasswordModal'));
            if (cancelChangePassword) cancelChangePassword.addEventListener('click', () => closeModal('changePasswordModal'));
            
            // Application buttons - FIXED
            const newApplicationBtn = document.getElementById('newApplicationBtn');
            const applyNewBtn = document.getElementById('applyNewBtn');
            
            console.log("New Application Button:", newApplicationBtn); // Debug log
            console.log("Apply New Button:", applyNewBtn); // Debug log
            
            if (newApplicationBtn) {
                newApplicationBtn.addEventListener('click', function(e) {
                    console.log("New Application button clicked!"); // Debug log
                    e.preventDefault();
                    openApplicationModal();
                });
            }
            
            if (applyNewBtn) {
                applyNewBtn.addEventListener('click', function(e) {
                    console.log("Apply New button clicked!"); // Debug log
                    e.preventDefault();
                    openApplicationModal();
                });
            }
            
            // Modal controls
            const closeModalBtn = document.getElementById('closeModal');
            const cancelApplication = document.getElementById('cancelApplication');
            const closeSuccessModal = document.getElementById('closeSuccessModal');
            const closeSuccessBtn = document.getElementById('closeSuccessBtn');
            const closeDetailsModal = document.getElementById('closeDetailsModal');
            
            if (closeModalBtn) closeModalBtn.addEventListener('click', () => closeModal('applicationModal'));
            if (cancelApplication) cancelApplication.addEventListener('click', () => closeModal('applicationModal'));
            if (closeSuccessModal) closeSuccessModal.addEventListener('click', () => closeModal('successModal'));
            if (closeSuccessBtn) closeSuccessBtn.addEventListener('click', () => closeModal('successModal'));
            if (closeDetailsModal) closeDetailsModal.addEventListener('click', () => closeModal('applicationDetailsModal'));
            
            // Success modal buttons
            const viewStatusBtn = document.getElementById('viewStatusBtn');
            if (viewStatusBtn) {
                viewStatusBtn.addEventListener('click', function() {
                    closeModal('successModal');
                    showPage('applicationPage');
                });
            }
            
            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Adakah anda pasti ingin log keluar?')) {
                        sessionStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                        currentUser = null;
                        showAuthentication();
                    }
                });
            }
            
            // Navigation links - DELEGATED EVENT LISTENER
            document.addEventListener('click', function(e) {
                const navLink = e.target.closest('.nav-links a');
                if (navLink) {
                    e.preventDefault();
                    const page = navLink.dataset.page;
                    if (page) {
                        showPage(page + 'Page');
                    }
                }
            });
            
            // Refresh applications (admin)
            const refreshApplications = document.getElementById('refreshApplications');
            if (refreshApplications) {
                refreshApplications.addEventListener('click', function() {
                    loadAdminApplications();
                    alert('Senarai permohonan telah dikemas kini!');
                });
            }
            
            // Add user button (admin)
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    alert('Fungsi tambah pengguna akan datang tidak lama lagi.');
                });
            }
            
            // Asset type change listener
            const assetTypeSelect = document.getElementById('assetType');
            if (assetTypeSelect) {
                assetTypeSelect.addEventListener('change', function() {
                    if (this.value) {
                        loadLocationsForAssetType(this.value);
                    } else {
                        resetLocationSelector();
                    }
                });
            }
            
            // Close details button
            document.addEventListener('click', function(e) {
                if (e.target.id === 'closeDetailsBtn') {
                    closeModal('applicationDetailsModal');
                }
            });
            
            // Quick access assets - DELEGATED EVENT LISTENER
            document.addEventListener('click', function(e) {
                const applyNowBtn = e.target.closest('.apply-now-btn');
                if (applyNowBtn) {
                    e.preventDefault();
                    const assetType = applyNowBtn.dataset.assetType;
                    openApplicationModal(assetType);
                }
            });
            
            console.log("Event listeners setup complete!"); // Debug log
        }
        
        // ... (Rest of the functions remain the same) ...
        
        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing system..."); // Debug log
            initializeSystem();
            setupEventListeners();
        });
    </script>
</body>
</html>
