<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Aset Sewaan - Lokasi Tersedia Semula</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f7a;
            --secondary: #57c5b6;
            --accent: #159895;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --reavailable: #20c997;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Authentication */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            padding: 20px;
        }
        
        .auth-container {
            display: flex;
            width: 100%;
            max-width: 1000px;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }
        
        .auth-left {
            flex: 1;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .auth-right {
            flex: 1;
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .auth-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
        }
        
        .auth-logo i {
            font-size: 2.5rem;
        }
        
        .auth-feature {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .auth-feature-icon {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
        }
        
        .auth-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-form-group {
            margin-bottom: 20px;
        }
        
        .auth-input-with-icon {
            position: relative;
        }
        
        .auth-input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .auth-input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .auth-btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        /* Main Application */
        .app-container {
            display: none;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: white;
            color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-reavailable {
            background-color: var(--reavailable);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 30px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            background-color: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        /* Navigation */
        .app-nav {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 5px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 15px 20px;
            display: inline-block;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(26, 95, 122, 0.1);
            color: var(--primary);
        }
        
        /* Dashboard */
        .app-main {
            padding: 2rem 0;
        }
        
        .welcome-banner {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        /* Notifications */
        .notification-container {
            margin-bottom: 20px;
        }
        
        .available-location-notification {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 5px solid var(--reavailable);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        /* Asset Cards */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 3rem;
        }
        
        .asset-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            border: 1px solid var(--light-gray);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .asset-card:hover {
            transform: translateY(-5px);
        }
        
        .asset-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-available {
            background-color: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }
        
        .status-reavailable {
            background-color: rgba(32, 201, 151, 0.15);
            color: var(--reavailable);
            border: 1px dashed var(--reavailable);
        }
        
        .asset-image {
            height: 180px;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            position: relative;
        }
        
        .asset-image i {
            font-size: 4rem;
            opacity: 0.5;
        }
        
        .asset-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .asset-actions {
            margin-top: auto;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            background-color: var(--light);
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* Reavailable badge */
        .reavailable-badge {
            display: inline-block;
            background-color: rgba(32, 201, 151, 0.15);
            color: var(--reavailable);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
            border: 1px dashed var(--reavailable);
        }
        
        /* Location option with special marker */
        .reavailable-option {
            color: var(--reavailable) !important;
            font-weight: bold !important;
            position: relative;
        }
        
        .reavailable-option:after {
            content: " ðŸ”„ Tersedia Semula";
            font-size: 0.8rem;
        }
        
        /* Page Content */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Authentication -->
    <div class="auth-page" id="authPage">
        <div class="auth-container">
            <div class="auth-left">
                <div class="auth-logo">
                    <i class="fas fa-building"></i>
                    <div>
                        <h1>Sistem Aset Sewaan</h1>
                        <p>Portal Permohonan & Pengurusan</p>
                    </div>
                </div>
                
                <div class="auth-features">
                    <div class="auth-feature">
                        <div class="auth-feature-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div>
                            <h4>181 Unit Kuarters</h4>
                            <p>49 unit masih tersedia untuk disewa</p>
                        </div>
                    </div>
                    
                    <div class="auth-feature">
                        <div class="auth-feature-icon">
                            <i class="fas fa-redo-alt"></i>
                        </div>
                        <div>
                            <h4>Lokasi Tersedia Semula</h4>
                            <p>Lokasi ditolak akan wujud semula untuk permohonan baru</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auth-right">
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="loginTab">Log Masuk</button>
                        <button class="auth-tab" id="registerTab">Daftar</button>
                    </div>
                    
                    <!-- Login Form -->
                    <form class="auth-form active" id="loginForm">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--primary); margin-bottom: 10px;">Log Masuk</h2>
                            <p>Sila masukkan maklumat akaun anda</p>
                        </div>
                        
                        <div class="auth-form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email atau No. KP</label>
                            <div class="auth-input-with-icon">
                                <i class="fas fa-user auth-input-icon"></i>
                                <input type="text" id="loginEmail" class="auth-input" placeholder="cth: user@email.com" required>
                            </div>
                        </div>
                        
                        <div class="auth-form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Kata Laluan</label>
                            <div class="auth-input-with-icon">
                                <i class="fas fa-lock auth-input-icon"></i>
                                <input type="password" id="loginPassword" class="auth-input" placeholder="Masukkan kata laluan" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="auth-btn auth-btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Log Masuk
                        </button>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <p>Tiada akaun? <a href="#" id="goToRegister" style="color: var(--primary);">Daftar di sini</a></p>
                        </div>
                    </form>
                    
                    <!-- Register Form -->
                    <form class="auth-form" id="registerForm">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--primary); margin-bottom: 10px;">Daftar Akaun</h2>
                            <p>Sila isi maklumat di bawah</p>
                        </div>
                        
                        <div class="auth-form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nama Penuh</label>
                            <input type="text" id="registerName" class="auth-input" placeholder="Masukkan nama penuh" required>
                        </div>
                        
                        <div class="auth-form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email</label>
                            <input type="email" id="registerEmail" class="auth-input" placeholder="cth: user@email.com" required>
                        </div>
                        
                        <div class="auth-form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Kata Laluan</label>
                            <input type="password" id="registerPassword" class="auth-input" placeholder="Minimum 8 aksara" required>
                        </div>
                        
                        <button type="submit" class="auth-btn auth-btn-primary">
                            <i class="fas fa-user-plus"></i> Daftar Akaun
                        </button>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <p>Sudah ada akaun? <a href="#" id="goToLogin" style="color: var(--primary);">Log masuk di sini</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="container header-content">
                <div class="app-logo">
                    <i class="fas fa-building"></i>
                    <div>
                        <h1>Portal Sewaan Aset</h1>
                        <p>Selamat datang, <span id="headerUserName">Pengguna</span></p>
                    </div>
                </div>
                
                <div class="user-section">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">P</div>
                        <div>
                            <div id="userName">Pengguna</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Log Keluar
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav class="app-nav">
            <div class="container nav-container">
                <ul class="nav-links" id="navLinks">
                    <!-- Navigation links will be loaded here -->
                </ul>
                
                <div>
                    <button class="btn btn-primary" id="newApplicationBtn">
                        <i class="fas fa-plus"></i> Mohon Baru
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="app-main">
            <div class="container">
                <!-- Notifications -->
                <div id="notificationContainer" class="notification-container"></div>
                
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-content active">
                    <div class="welcome-banner">
                        <h2 id="welcomeTitle">Selamat Datang!</h2>
                        <p id="welcomeMessage">Portal sewaan aset.</p>
                    </div>
                    
                    <!-- User Dashboard -->
                    <div id="userDashboard">
                        <h2 style="color: var(--primary); margin-bottom: 1rem;">Akses Pantas</h2>
                        <div class="assets-grid" id="quickAccessAssets">
                            <!-- Quick access cards will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Admin Dashboard -->
                    <div id="adminDashboard" style="display: none;">
                        <div style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">Statistik</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="totalApplications">0</div>
                                    <div style="color: var(--gray);">Jumlah Permohonan</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--warning);" id="pendingApplications">0</div>
                                    <div style="color: var(--gray);">Permohonan Baru</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--reavailable);" id="reavailableLocations">0</div>
                                    <div style="color: var(--gray);">Lokasi Tersedia Semula</div>
                                </div>
                            </div>
                        </div>
                        
                        <h2 style="color: var(--primary); margin-bottom: 1rem;">Permohonan Terkini</h2>
                        <div id="adminApplicationsList" style="background: white; border-radius: 10px; overflow: hidden;">
                            <!-- Applications will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Application Page -->
                <div id="applicationPage" class="page-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--primary);">Permohonan Saya</h2>
                        <button class="btn btn-primary" id="applyNewBtn">
                            <i class="fas fa-plus"></i> Permohonan Baru
                        </button>
                    </div>
                    
                    <div id="applicationStatus" style="background: white; border-radius: 12px; padding: 2rem;">
                        <!-- Applications will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Application Modal -->
    <div class="modal" id="applicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Borang Permohonan Sewaan</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="rentalApplicationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Penuh</label>
                            <input type="text" id="applicantName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="applicantEmail" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Jenis Aset Dipohon</label>
                        <select id="assetType" class="form-control" required>
                            <option value="">Sila Pilih</option>
                            <option value="kuarters">Kuarters Kakitangan</option>
                            <option value="pejabat">Pejabat</option>
                            <option value="tanah">Tanah Lot</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Lokasi Pilihan</label>
                        <div id="locationContainer">
                            <select id="location" class="form-control" required disabled style="display: none;">
                                <option value="">Pilih jenis aset dahulu</option>
                            </select>
                            <div id="locationInitialMessage" style="padding: 1rem; background-color: #f8f9fa; border-radius: 6px;">
                                <i class="fas fa-info-circle"></i> Sila pilih jenis aset terlebih dahulu
                            </div>
                        </div>
                        <div id="vacancyInfo" style="margin-top: 5px; font-size: 0.9rem;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Tujuan Permohonan</label>
                        <textarea id="purpose" class="form-control" placeholder="Sila nyatakan tujuan permohonan..." required></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn" id="cancelApplication">Batal</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Hantar 
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Application Details Modal (Admin) -->
    <div class="modal" id="applicationDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Butiran Permohonan</h3>
                <button class="close-modal" id="closeDetailsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="applicationDetailsContent">
                    <!-- Application details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer" id="applicationDetailsFooter">
                <!-- Action buttons will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA STORAGE AND INITIALIZATION
        // ============================================
        
        // Data Kekosongan Lokasi
        const VACANCY_DATA = {
            kuarters: [
                { id: 'Q001', name: 'Kuarters Kuala Perlis, Perlis', vacancies: 2 },
                { id: 'Q002', name: 'Kuarters Langkawi, Kedah', vacancies: 1 },
                { id: 'Q003', name: 'Kuarters Meru, Selangor', vacancies: 3 }
            ],
            pejabat: [
                { id: 'O001', name: 'Pejabat Port Dickson, Negeri Sembilan', vacancies: 1 },
                { id: 'O002', name: 'Pejabat Johor Bahru, Johor', vacancies: 2 }
            ],
            tanah: [
                { id: 'L001', name: 'Tanah Lot Shah Alam, Selangor', vacancies: 1 },
                { id: 'L002', name: 'Tanah Lot Kuala Lumpur', vacancies: 1 }
            ]
        };
        
        // Demo Users
        const DEMO_USERS = [
            {
                id: 1,
                name: "Ahmad bin Ali",
                email: "ahmad@email.com",
                password: "password123",
                role: "user"
            },
            {
                id: 2,
                name: "Admin Sistem",
                email: "admin@email.com",
                password: "admin123",
                role: "admin"
            }
        ];
        
        // Asset Data
        const ASSETS_DATA = [
            {
                type: "kuarters",
                name: "Kuarters Kakitangan",
                icon: "fas fa-home",
                color: "#9b59b6",
                description: "Kuarters untuk kakitangan kerajaan dengan kemudahan lengkap.",
                totalUnits: 10,
                availableUnits: 6
            },
            {
                type: "pejabat",
                name: "Sewa Pejabat",
                icon: "fas fa-building",
                color: "#3498db",
                description: "Pejabat di lokasi strategik dengan kemudahan lengkap.",
                totalUnits: 5,
                availableUnits: 3
            },
            {
                type: "tanah",
                name: "Tanah Lot",
                icon: "fas fa-map-marked-alt",
                color: "#2ecc71",
                description: "Tanah lot untuk tujuan perindustrian atau komersial.",
                totalUnits: 4,
                availableUnits: 2
            }
        ];
        
        let currentUser = null;
        let users = [];
        let applications = [];
        let vacancies = JSON.parse(JSON.stringify(VACANCY_DATA)); // Deep copy
        
        // Initialize System
        function initializeSystem() {
            // Initialize users
            const storedUsers = localStorage.getItem('asset_rental_users');
            if (!storedUsers) {
                users = DEMO_USERS;
                localStorage.setItem('asset_rental_users', JSON.stringify(users));
            } else {
                users = JSON.parse(storedUsers);
            }
            
            // Initialize applications
            const storedApps = localStorage.getItem('user_applications');
            applications = storedApps ? JSON.parse(storedApps) : [];
            
            // Initialize vacancies
            const storedVacancies = localStorage.getItem('asset_vacancies');
            if (storedVacancies) {
                vacancies = JSON.parse(storedVacancies);
            } else {
                localStorage.setItem('asset_vacancies', JSON.stringify(vacancies));
            }
            
            // Check login status
            checkLoginStatus();
        }
        
        function checkLoginStatus() {
            const storedUser = sessionStorage.getItem('current_asset_user') || 
                              localStorage.getItem('current_asset_user');
            
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showApplication();
            } else {
                showAuthentication();
            }
        }
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        function showAuthentication() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            switchAuthTab('login');
        }
        
        function showApplication() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateUserInterface();
            loadDashboard();
            showAvailableLocationsNotification();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === identifier);
            
            if (!user) {
                alert('Akaun tidak ditemui');
                return;
            }
            
            if (user.password !== password) {
                alert('Kata laluan tidak betul');
                return;
            }
            
            // Login successful
            currentUser = {
                id: user.id,
                name: user.name,
                email: user.email,
                role: user.role
            };
            
            // Save to storage
            sessionStorage.setItem('current_asset_user', JSON.stringify(currentUser));
            localStorage.setItem('current_asset_user', JSON.stringify(currentUser));
            
            showApplication();
        }
        
        function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // Check if user already exists
            if (users.find(u => u.email === email)) {
                alert('Email sudah didaftarkan');
                return;
            }
            
            const userData = {
                id: Date.now(),
                name: name,
                email: email,
                password: password,
                role: 'user'
            };
            
            users.push(userData);
            localStorage.setItem('asset_rental_users', JSON.stringify(users));
            
            alert('Pendaftaran berjaya! Sila log masuk.');
            switchAuthTab('login');
        }
        
        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        
        function loadDashboard() {
            if (currentUser.role === 'admin') {
                document.getElementById('userDashboard').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadAdminDashboard();
            } else {
                document.getElementById('userDashboard').style.display = 'block';
                document.getElementById('adminDashboard').style.display = 'none';
                loadUserDashboard();
            }
        }
        
        function loadUserDashboard() {
            loadQuickAccessAssets();
            loadUserApplications();
        }
        
        function loadQuickAccessAssets() {
            const assetsGrid = document.getElementById('quickAccessAssets');
            assetsGrid.innerHTML = '';
            
            ASSETS_DATA.forEach(asset => {
                const totalVacancies = vacancies[asset.type]?.reduce((sum, loc) => sum + loc.vacancies, 0) || 0;
                
                // Check for reavailable locations for current user
                const userReavailableLocations = getReavailableLocationsForUser(currentUser.id, asset.type);
                const hasReavailable = userReavailableLocations.length > 0;
                
                // Determine status
                let statusClass, statusText;
                if (hasReavailable) {
                    statusClass = 'status-reavailable';
                    statusText = `${userReavailableLocations.length} Tersedia Semula`;
                } else if (totalVacancies > 0) {
                    statusClass = 'status-available';
                    statusText = `${totalVacancies} Tersedia`;
                } else {
                    statusClass = 'status-available';
                    statusText = 'Tidak Tersedia';
                }
                
                const card = document.createElement('div');
                card.className = 'asset-card';
                card.innerHTML = `
                    <div class="asset-image" style="background-color: ${asset.color}20; color: ${asset.color};">
                        <i class="${asset.icon}"></i>
                        <div class="asset-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    <div class="asset-content">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">${asset.name}</h3>
                        <p style="margin-bottom: 20px;">${asset.description}</p>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--gray);">Unit Tersedia:</span>
                                <span style="font-weight: 500;">${totalVacancies} / ${asset.totalUnits}</span>
                            </div>
                            ${hasReavailable ? `
                            <div style="color: var(--reavailable); font-weight: bold; margin-top: 10px;">
                                <i class="fas fa-redo-alt"></i> ${userReavailableLocations.length} lokasi tersedia semula untuk anda
                            </div>
                            ` : ''}
                        </div>
                        <div class="asset-actions">
                            ${totalVacancies > 0 ? `
                            <button class="btn ${hasReavailable ? 'btn-reavailable' : 'btn-primary'} btn-block apply-now-btn" data-asset-type="${asset.type}">
                                <i class="fas fa-pen"></i> ${hasReavailable ? 'Mohon Semula' : 'Mohon Sekarang'}
                            </button>
                            ` : `
                            <button class="btn btn-block" disabled style="background-color: #e9ecef; color: #6c757d;">
                                <i class="fas fa-times-circle"></i> Tiada Kekosongan
                            </button>
                            `}
                        </div>
                    </div>
                `;
                assetsGrid.appendChild(card);
            });
            
            // Add event listeners to apply buttons
            document.querySelectorAll('.apply-now-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openApplicationModal(this.dataset.assetType);
                });
            });
        }
        
        function loadUserApplications() {
            const statusList = document.getElementById('applicationStatus');
            const userApps = applications.filter(app => app.applicantId === currentUser.id);
            
            if (userApps.length === 0) {
                statusList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <i class="fas fa-file-alt" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                        <h3>Tiada Permohonan</h3>
                        <p>Anda belum membuat sebarang permohonan.</p>
                    </div>
                `;
                return;
            }
            
            statusList.innerHTML = '';
            userApps.forEach(app => {
                // Check if location is now available again
                const location = vacancies[app.assetType]?.find(loc => loc.id === app.locationId);
                const isReavailable = app.status === 'rejected' && location && location.vacancies > 0;
                
                const item = document.createElement('div');
                item.style.cssText = `
                    background-color: var(--light);
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    border-left: 5px solid ${app.status === 'pending' ? 'var(--warning)' : app.status === 'approved' ? 'var(--success)' : 'var(--danger)'};
                `;
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin-bottom: 5px;">${app.assetName}</h4>
                            <p style="color: var(--gray); font-size: 0.9rem;">
                                No. Rujukan: ${app.reference} | Lokasi: ${app.location} | Tarikh: ${formatDate(app.applyDate)}
                            </p>
                            ${app.status === 'rejected' && app.rejectionReason ? `
                            <div style="background-color: rgba(220, 53, 69, 0.1); padding: 10px; border-radius: 5px; margin-top: 5px; font-size: 0.9rem;">
                                <strong><i class="fas fa-times-circle"></i> Alasan Penolakan:</strong> ${app.rejectionReason}
                            </div>
                            ` : ''}
                            ${isReavailable ? `
                            <div style="background-color: rgba(32, 201, 151, 0.1); padding: 10px; border-radius: 5px; margin-top: 5px; font-size: 0.9rem; border: 1px dashed var(--reavailable);">
                                <strong><i class="fas fa-redo-alt"></i> Lokasi Tersedia Semula!</strong> Anda boleh memohon semula pada lokasi ini.
                            </div>
                            ` : ''}
                        </div>
                        <div style="padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
                            background-color: ${app.status === 'pending' ? 'rgba(255, 193, 7, 0.15)' : app.status === 'approved' ? 'rgba(40, 167, 69, 0.15)' : 'rgba(220, 53, 69, 0.15)'};
                            color: ${app.status === 'pending' ? '#b88b00' : app.status === 'approved' ? 'var(--success)' : 'var(--danger)'};
                            ${isReavailable ? 'border: 1px dashed var(--reavailable); color: var(--reavailable); background-color: rgba(32, 201, 151, 0.15);' : ''}
                        ">
                            ${app.status === 'pending' ? 'Menunggu Admin' : app.status === 'approved' ? 'Diluluskan' : 'Ditolak'}
                            ${isReavailable ? '<br><small style="font-size: 0.7rem;">(Tersedia semula)</small>' : ''}
                        </div>
                    </div>
                `;
                statusList.appendChild(item);
            });
        }
        
        function loadAdminDashboard() {
            // Update statistics
            document.getElementById('totalApplications').textContent = applications.length;
            document.getElementById('pendingApplications').textContent = applications.filter(app => app.status === 'pending').length;
            
            // Calculate reavailable locations
            let reavailableCount = 0;
            applications.forEach(app => {
                if (app.status === 'rejected') {
                    const location = vacancies[app.assetType]?.find(loc => loc.id === app.locationId);
                    if (location && location.vacancies > 0) {
                        reavailableCount++;
                    }
                }
            });
            document.getElementById('reavailableLocations').textContent = reavailableCount;
            
            loadAdminApplications();
        }
        
        function loadAdminApplications() {
            const appList = document.getElementById('adminApplicationsList');
            appList.innerHTML = '';
            
            const sortedApps = [...applications].sort((a, b) => new Date(b.applyDate) - new Date(a.applyDate));
            
            if (sortedApps.length === 0) {
                appList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--success);"></i>
                        <h4>Tiada Permohonan</h4>
                        <p>Belum ada permohonan dibuat.</p>
                    </div>
                `;
                return;
            }
            
            sortedApps.forEach((app, index) => {
                // Check if location is now available
                const location = vacancies[app.assetType]?.find(loc => loc.id === app.locationId);
                const isReavailable = app.status === 'rejected' && location && location.vacancies > 0;
                
                const row = document.createElement('div');
                row.style.cssText = `
                    padding: 1rem;
                    border-bottom: 1px solid var(--light-gray);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                let statusBadge;
                if (app.status === 'pending') {
                    statusBadge = '<span style="padding: 3px 10px; border-radius: 15px; background-color: rgba(255, 193, 7, 0.15); color: #b88b00;">Menunggu</span>';
                } else if (app.status === 'approved') {
                    statusBadge = '<span style="padding: 3px 10px; border-radius: 15px; background-color: rgba(40, 167, 69, 0.15); color: var(--success);">Diluluskan</span>';
                } else {
                    if (isReavailable) {
                        statusBadge = '<span style="padding: 3px 10px; border-radius: 15px; background-color: rgba(32, 201, 151, 0.15); color: var(--reavailable); border: 1px dashed var(--reavailable);">Ditolak ðŸ”„</span>';
                    } else {
                        statusBadge = '<span style="padding: 3px 10px; border-radius: 15px; background-color: rgba(220, 53, 69, 0.15); color: var(--danger);">Ditolak</span>';
                    }
                }
                
                row.innerHTML = `
                    <div style="flex: 1;">
                        <div><strong>${app.applicantName}</strong></div>
                        <div style="color: var(--gray); font-size: 0.9rem;">${app.assetName} - ${app.location}</div>
                        <div style="color: var(--gray); font-size: 0.8rem;">${formatDate(app.applyDate)}</div>
                    </div>
                    <div style="margin: 0 20px;">
                        ${statusBadge}
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="action-btn" style="padding: 5px 10px; border-radius: 4px; border: none; background-color: var(--primary); color: white; cursor: pointer;" data-app-id="${app.id}" data-action="view">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${app.status === 'pending' ? `
                        <button class="action-btn" style="padding: 5px 10px; border-radius: 4px; border: none; background-color: var(--success); color: white; cursor: pointer;" data-app-id="${app.id}" data-action="approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn" style="padding: 5px 10px; border-radius: 4px; border: none; background-color: var(--danger); color: white; cursor: pointer;" data-app-id="${app.id}" data-action="reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                appList.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('[data-action="view"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewApplicationDetails(this.dataset.appId);
                });
            });
            
            document.querySelectorAll('[data-action="approve"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    processApplication(this.dataset.appId, 'approved');
                });
            });
            
            document.querySelectorAll('[data-action="reject"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    processApplication(this.dataset.appId, 'rejected');
                });
            });
        }
        
        // ============================================
        // REAVAILABLE LOCATION FUNCTIONS
        // ============================================
        
        function getReavailableLocationsForUser(userId, assetType) {
            const userApplications = applications.filter(app => 
                app.applicantId == userId && 
                app.assetType === assetType && 
                app.status === 'rejected'
            );
            
            const reavailableLocations = [];
            
            userApplications.forEach(app => {
                const location = vacancies[assetType]?.find(loc => loc.id === app.locationId);
                if (location && location.vacancies > 0) {
                    reavailableLocations.push({
                        locationId: location.id,
                        locationName: location.name,
                        vacancies: location.vacancies,
                        applicationId: app.id,
                        reference: app.reference
                    });
                }
            });
            
            return reavailableLocations;
        }
        
        function showAvailableLocationsNotification() {
            if (currentUser && currentUser.role === 'user') {
                const notificationContainer = document.getElementById('notificationContainer');
                notificationContainer.innerHTML = '';
                
                // Cari semua lokasi yang pernah ditolak tetapi kini tersedia
                let allReavailableLocations = [];
                
                Object.keys(vacancies).forEach(assetType => {
                    const reavailableLocs = getReavailableLocationsForUser(currentUser.id, assetType);
                    allReavailableLocations = [...allReavailableLocations, ...reavailableLocs];
                });
                
                // Tunjukkan notifikasi jika ada lokasi tersedia semula
                if (allReavailableLocations.length > 0) {
                    const notification = document.createElement('div');
                    notification.className = 'available-location-notification';
                    
                    notification.innerHTML = `
                        <h4 style="color: #155724; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-circle"></i> Lokasi Tersedia Semula!
                        </h4>
                        <p style="color: #155724; margin-bottom: 10px;">
                            ${allReavailableLocations.length} lokasi yang pernah anda mohon kini tersedia semula:
                        </p>
                        <ul style="margin-left: 20px; color: #155724;">
                            ${allReavailableLocations.map(loc => 
                                `<li><strong>${loc.locationName}</strong> (${loc.vacancies} kosong)</li>`
                            ).join('')}
                        </ul>
                        <p style="color: #155724; margin-top: 10px;">
                            <i class="fas fa-lightbulb"></i> Anda boleh memohon semula pada lokasi ini melalui borang permohonan.
                        </p>
                    `;
                    
                    notificationContainer.appendChild(notification);
                }
            }
        }
        
        // ============================================
        // APPLICATION FUNCTIONS
        // ============================================
        
        function openApplicationModal(assetType = null) {
            const modal = document.getElementById('applicationModal');
            modal.style.display = 'flex';
            
            // Reset location selector
            resetLocationSelector();
            
            // Auto-fill user data
            if (currentUser) {
                document.getElementById('applicantName').value = currentUser.name;
                document.getElementById('applicantEmail').value = currentUser.email;
            }
            
            // Set asset type if provided
            if (assetType) {
                document.getElementById('assetType').value = assetType;
                loadLocationsForAssetType(assetType);
            }
            
            // Reset form
            document.getElementById('purpose').value = '';
        }
        
        function resetLocationSelector() {
            const locationSelect = document.getElementById('location');
            const locationInitialMessage = document.getElementById('locationInitialMessage');
            
            locationSelect.style.display = 'none';
            locationSelect.disabled = true;
            locationInitialMessage.style.display = 'block';
            document.getElementById('vacancyInfo').innerHTML = '';
            
            // Clear location options
            locationSelect.innerHTML = '<option value="">Pilih jenis aset dahulu</option>';
        }
        
        function loadLocationsForAssetType(assetType) {
            const locationSelect = document.getElementById('location');
            const locationInitialMessage = document.getElementById('locationInitialMessage');
            const vacancyInfo = document.getElementById('vacancyInfo');
            
            // Show loading
            locationInitialMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sedang memuatkan lokasi...';
            
            // Get locations for this asset type
            const assetLocations = vacancies[assetType] || [];
            
            // Filter locations with vacancies > 0
            const availableLocations = assetLocations.filter(loc => loc.vacancies > 0);
            
            setTimeout(() => {
                if (availableLocations.length === 0) {
                    locationInitialMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Tiada kekosongan tersedia untuk jenis aset ini';
                    locationSelect.style.display = 'none';
                    vacancyInfo.innerHTML = '';
                    return;
                }
                
                // Show dropdown
                locationInitialMessage.style.display = 'none';
                locationSelect.style.display = 'block';
                locationSelect.disabled = false;
                
                // Clear existing options
                locationSelect.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `-- Pilih Lokasi (${availableLocations.length} pilihan) --`;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                locationSelect.appendChild(defaultOption);
                
                // Get user's previous applications to mark rejected locations
                const userApplications = applications.filter(app => 
                    app.applicantId == currentUser.id && 
                    app.assetType === assetType && 
                    app.status === 'rejected'
                );
                
                // Add available locations with special markers for previously rejected ones
                availableLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    
                    // Check if this location was previously rejected for this user
                    const wasRejected = userApplications.some(app => app.locationId === location.id);
                    
                    if (wasRejected) {
                        option.className = 'reavailable-option';
                        option.textContent = `${location.name} (${location.vacancies} kosong)`;
                    } else {
                        option.textContent = `${location.name} (${location.vacancies} kosong)`;
                    }
                    
                    locationSelect.appendChild(option);
                });
                
                // Show vacancy info
                const totalVacancies = availableLocations.reduce((sum, loc) => sum + loc.vacancies, 0);
                const reavailableCount = availableLocations.filter(loc => 
                    userApplications.some(app => app.locationId === loc.id)
                ).length;
                
                let infoText = `ðŸ“Š ${totalVacancies} unit kosong di ${availableLocations.length} lokasi berbeza`;
                if (reavailableCount > 0) {
                    infoText += ` | ðŸ”„ ${reavailableCount} lokasi tersedia semula untuk anda`;
                }
                
                vacancyInfo.innerHTML = infoText;
                vacancyInfo.style.color = reavailableCount > 0 ? 'var(--reavailable)' : 'var(--success)';
                
                // Add change event listener
                locationSelect.addEventListener('change', function() {
                    const selectedLocation = availableLocations.find(loc => loc.id === this.value);
                    if (selectedLocation) {
                        const wasRejected = userApplications.some(app => app.locationId === selectedLocation.id);
                        let locationInfo = `ðŸ“ ${selectedLocation.name}: ${selectedLocation.vacancies} unit kosong`;
                        
                        if (wasRejected) {
                            locationInfo += ` | ðŸ”„ Lokasi ini tersedia semula untuk anda!`;
                        }
                        
                        vacancyInfo.innerHTML = locationInfo;
                    }
                });
            }, 500);
        }
        
        function submitApplication(e) {
            e.preventDefault();
            
            const assetType = document.getElementById('assetType').value;
            const locationId = document.getElementById('location').value;
            
            if (!assetType || !locationId) {
                alert('Sila pilih jenis aset dan lokasi yang sah.');
                return;
            }
            
            // Get selected location details
            const availableLocations = vacancies[assetType] || [];
            const selectedLocation = availableLocations.find(loc => loc.id === locationId);
            
            if (!selectedLocation || selectedLocation.vacancies <= 0) {
                alert('Lokasi yang dipilih tidak mempunyai kekosongan. Sila pilih lokasi lain.');
                return;
            }
            
            // Check if this is a reapplication for a previously rejected location
            const previousApplication = applications.find(app => 
                app.applicantId === currentUser.id && 
                app.assetType === assetType && 
                app.locationId === locationId && 
                app.status === 'rejected'
            );
            
            // Create application
            const application = {
                id: Date.now(),
                reference: `APP-${new Date().getFullYear()}-${String(applications.length + 1).padStart(3, '0')}`,
                assetType: assetType,
                assetName: document.getElementById('assetType').options[document.getElementById('assetType').selectedIndex].text,
                location: selectedLocation.name,
                locationId: locationId,
                applyDate: new Date().toISOString().split('T')[0],
                applicantId: currentUser.id,
                applicantName: document.getElementById('applicantName').value,
                applicantEmail: document.getElementById('applicantEmail').value,
                purpose: document.getElementById('purpose').value,
                status: 'pending',
                isReapplication: !!previousApplication,
                previousReference: previousApplication ? previousApplication.reference : null
            };
            
            // Save application
            applications.unshift(application);
            localStorage.setItem('user_applications', JSON.stringify(applications));
            
            // Update vacancy count (reduce by 1)
            selectedLocation.vacancies -= 1;
            localStorage.setItem('asset_vacancies', JSON.stringify(vacancies));
            
            // Show success message
            alert(`Permohonan berjaya dihantar!\nNo. Rujukan: ${application.reference}\n\nLokasi: ${application.location}`);
            
            // Close modal
            closeModal('applicationModal');
            
            // Update dashboard
            loadDashboard();
            
            // Update notifications
            showAvailableLocationsNotification();
        }
        
        function viewApplicationDetails(appId) {
            const app = applications.find(a => a.id == appId);
            if (!app) return;
            
            const modal = document.getElementById('applicationDetailsModal');
            const content = document.getElementById('applicationDetailsContent');
            const footer = document.getElementById('applicationDetailsFooter');
            
            // Check if location is now available
            const location = vacancies[app.assetType]?.find(loc => loc.id === app.locationId);
            const isReavailable = app.status === 'rejected' && location && location.vacancies > 0;
            
            content.innerHTML = `
                <div style="background-color: var(--light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Maklumat Permohonan</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">No. Rujukan:</span>
                        <span style="font-weight: 500;">${app.reference}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Tarikh Mohon:</span>
                        <span style="font-weight: 500;">${formatDate(app.applyDate)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Jenis Aset:</span>
                        <span style="font-weight: 500;">${app.assetName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Lokasi:</span>
                        <span style="font-weight: 500;">${app.location}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Status:</span>
                        <span style="font-weight: 500; color: ${app.status === 'pending' ? 'var(--warning)' : app.status === 'approved' ? 'var(--success)' : 'var(--danger)'};">
                            ${app.status === 'pending' ? 'Menunggu Kelulusan' : app.status === 'approved' ? 'Diluluskan' : 'Ditolak'}
                        </span>
                    </div>
                    ${app.status === 'rejected' && app.rejectionReason ? `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Alasan Penolakan:</span>
                        <span style="font-weight: 500;">${app.rejectionReason}</span>
                    </div>
                    ` : ''}
                    ${isReavailable ? `
                    <div style="background-color: rgba(32, 201, 151, 0.1); padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px dashed var(--reavailable);">
                        <strong><i class="fas fa-redo-alt"></i> Lokasi Tersedia Semula!</strong> 
                        Lokasi ini kini mempunyai ${location.vacancies} kekosongan.
                    </div>
                    ` : ''}
                </div>
                
                <div style="background-color: var(--light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Maklumat Pemohon</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Nama:</span>
                        <span style="font-weight: 500;">${app.applicantName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Email:</span>
                        <span style="font-weight: 500;">${app.applicantEmail}</span>
                    </div>
                </div>
                
                <div style="background-color: var(--light); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Tujuan Permohonan</h4>
                    <p>${app.purpose}</p>
                </div>
                
                ${app.status === 'pending' ? `
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <h4 style="color: #856404; margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i> Tindakan Pentadbir</h4>
                    <div>
                        <label>Alasan Penolakan (jika perlu):</label>
                        <textarea id="rejectionReasonInput" class="form-control" rows="3" placeholder="Nyatakan alasan jika permohonan ditolak..." style="margin-top: 10px;"></textarea>
                    </div>
                </div>
                ` : ''}
            `;
            
            if (app.status === 'pending') {
                footer.innerHTML = `
                    <button class="btn btn-success" data-app-id="${app.id}" data-action="approve">
                        <i class="fas fa-check"></i> Luluskan
                    </button>
                    <button class="btn btn-danger" data-app-id="${app.id}" data-action="reject">
                        <i class="fas fa-times"></i> Tolak
                    </button>
                    <button class="btn" id="closeDetailsBtn">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                `;
            } else {
                footer.innerHTML = `
                    <button class="btn" id="closeDetailsBtn">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                `;
            }
            
            modal.style.display = 'flex';
            
            // Add event listeners
            document.querySelectorAll('[data-action="approve"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    processApplication(this.dataset.appId, 'approved');
                    closeModal('applicationDetailsModal');
                });
            });
            
            document.querySelectorAll('[data-action="reject"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    processApplication(this.dataset.appId, 'rejected');
                    closeModal('applicationDetailsModal');
                });
            });
        }
        
        function processApplication(appId, status) {
            const app = applications.find(a => a.id == appId);
            if (!app) return;
            
            app.status = status;
            app.processedDate = new Date().toISOString().split('T')[0];
            
            // Tambah alasan penolakan jika ada
            if (status === 'rejected') {
                const rejectionReason = document.getElementById('rejectionReasonInput')?.value;
                if (rejectionReason) {
                    app.rejectionReason = rejectionReason;
                }
                
                // ðŸ”¥ PENTING: Kembalikan kekosongan lokasi!
                const location = vacancies[app.assetType]?.find(loc => loc.id === app.locationId);
                if (location) {
                    location.vacancies += 1; // Tambah semula kekosongan
                }
            }
            
            // Save to localStorage
            localStorage.setItem('user_applications', JSON.stringify(applications));
            localStorage.setItem('asset_vacancies', JSON.stringify(vacancies));
            
            // Update dashboard
            loadDashboard();
            
            // Show confirmation
            let message = `Permohonan ${app.reference} telah ${status === 'approved' ? 'diluluskan' : 'ditolak'}.`;
            if (status === 'rejected') {
                message += `\n\nLokasi "${app.location}" telah dikembalikan ke senarai kekosongan.`;
                message += `\nPemohon boleh memohon semula pada lokasi ini.`;
            }
            alert(message);
            
            // If admin is processing, reload the admin applications list
            if (currentUser.role === 'admin') {
                loadAdminApplications();
            }
            
            // Update notifications for user
            if (status === 'rejected') {
                // In a real system, you might want to notify the user
                console.log(`Lokasi ${app.location} tersedia semula untuk pengguna ${app.applicantName}`);
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ms-MY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId.replace('Page', '')) {
                    link.classList.add('active');
                }
            });
            
            // Load page content
            if (pageId === 'dashboardPage') {
                loadDashboard();
            } else if (pageId === 'applicationPage') {
                if (currentUser.role === 'admin') {
                    loadAdminApplications();
                } else {
                    loadUserApplications();
                }
            }
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update header
            document.getElementById('headerUserName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            document.getElementById('userName').textContent = currentUser.name;
            
            // Update welcome message
            document.getElementById('welcomeTitle').textContent = `Selamat Datang, ${currentUser.name.split(' ')[0]}!`;
            
            // Update navigation based on role
            updateNavigation();
        }
        
        function updateNavigation() {
            const navLinks = document.getElementById('navLinks');
            navLinks.innerHTML = '';
            
            const links = [
                { page: 'dashboard', icon: 'fas fa-home', text: 'Dashboard' }
            ];
            
            if (currentUser.role === 'admin') {
                links.push(
                    { page: 'application', icon: 'fas fa-file-alt', text: 'Semua Permohonan' }
                );
            } else {
                links.push(
                    { page: 'application', icon: 'fas fa-file-alt', text: 'Permohonan Saya' }
                );
            }
            
            links.forEach(link => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="${link.page === 'dashboard' ? 'active' : ''}" data-page="${link.page}">
                        <i class="${link.icon}"></i> ${link.text}
                    </a>
                `;
                navLinks.appendChild(li);
            });
            
            // Hide new application button for admin
            if (currentUser.role === 'admin') {
                document.getElementById('newApplicationBtn').style.display = 'none';
            }
        }
        
        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        
        function setupEventListeners() {
            // Authentication tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            document.getElementById('goToRegister').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('register');
            });
            document.getElementById('goToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('rentalApplicationForm').addEventListener('submit', submitApplication);
            
            // Modal close buttons
            document.getElementById('closeModal').addEventListener('click', () => closeModal('applicationModal'));
            document.getElementById('cancelApplication').addEventListener('click', () => closeModal('applicationModal'));
            document.getElementById('closeDetailsModal')?.addEventListener('click', () => closeModal('applicationDetailsModal'));
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Adakah anda pasti ingin log keluar?')) {
                    sessionStorage.removeItem('current_asset_user');
                    localStorage.removeItem('current_asset_user');
                    currentUser = null;
                    showAuthentication();
                }
            });
            
            // Navigation links
            document.addEventListener('click', function(e) {
                if (e.target.closest('.nav-links a')) {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    const page = link.dataset.page;
                    showPage(page + 'Page');
                }
            });
            
            // New application button
            document.getElementById('newApplicationBtn').addEventListener('click', () => openApplicationModal());
            document.getElementById('applyNewBtn').addEventListener('click', () => openApplicationModal());
            
            // Asset type change listener
            document.getElementById('assetType').addEventListener('change', function() {
                if (this.value) {
                    loadLocationsForAssetType(this.value);
                } else {
                    resetLocationSelector();
                }
            });
            
            // Close details button
            document.addEventListener('click', function(e) {
                if (e.target.id === 'closeDetailsBtn') {
                    closeModal('applicationDetailsModal');
                }
            });
        }
        
        function switchAuthTab(tabName) {
            // Hide all forms
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            
            // Update tabs
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.remove('active');
            
            // Show selected form
            if (tabName === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('registerTab').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }
        
        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            setupEventListeners();
        });
    </script>
</body>
</html>
