<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Aset Sewaan - Portal Lengkap</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f7a;
            --secondary: #57c5b6;
            --accent: #159895;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --admin-primary: #2c3e50;
            --admin-secondary: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ... (CSS Authentication styles remain the same) ... */
        
        /* Profile Picture Styles */
        .profile-picture-container {
            position: relative;
            display: inline-block;
        }
        
        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            overflow: hidden;
        }
        
        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }
        
        .change-profile-picture {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
            transition: all 0.3s;
        }
        
        .change-profile-picture:hover {
            background-color: var(--accent);
            transform: scale(1.1);
        }
        
        .profile-picture-input {
            display: none;
        }
        
        .profile-picture-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .profile-picture-btn {
            padding: 5px 15px;
            font-size: 0.8rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-picture-btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .profile-picture-btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .profile-picture-btn:hover {
            opacity: 0.9;
        }
        
        /* ... (Rest of CSS styles remain the same) ... */
    </style>
</head>
<body>
    <!-- ... (Authentication Pages remain the same) ... -->
    
    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- ... (Header and Navigation remain the same) ... -->
        
        <!-- Main Content -->
        <main class="app-main">
            <div class="container">
                <!-- ... (Other pages remain the same) ... -->
                
                <!-- Profile Page -->
                <div id="profilePage" class="page-content">
                    <div class="section-header">
                        <h2>Profil Saya</h2>
                        <div class="profile-actions">
                            <button class="btn btn-primary" id="editProfileBtn">
                                <i class="fas fa-edit"></i> Kemaskini Profil
                            </button>
                            <button class="btn btn-success" id="saveProfileBtn" style="display: none;">
                                <i class="fas fa-save"></i> Simpan Perubahan
                            </button>
                            <button class="btn" id="cancelEditBtn" style="display: none;">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card" style="background-color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05);" id="profileCard">
                        <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 2rem;">
                            <div class="profile-picture-container">
                                <div class="profile-picture" id="profilePicture">
                                    <!-- Profile picture will be loaded here -->
                                    <div class="profile-picture-placeholder" id="profilePicturePlaceholder">
                                        <!-- Initials will be displayed here -->
                                    </div>
                                </div>
                                <div class="change-profile-picture" id="changeProfilePictureBtn" title="Tukar gambar profil">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="profilePictureInput" class="profile-picture-input" accept="image/*">
                                <div class="profile-picture-actions" id="profilePictureActions" style="display: none;">
                                    <button class="profile-picture-btn profile-picture-btn-primary" id="saveProfilePictureBtn">
                                        <i class="fas fa-save"></i> Simpan
                                    </button>
                                    <button class="profile-picture-btn" id="cancelProfilePictureBtn">
                                        <i class="fas fa-times"></i> Batal
                                    </button>
                                </div>
                            </div>
                            <div style="flex-grow: 1;">
                                <div class="profile-view-mode">
                                    <h3 style="color: var(--primary); margin-bottom: 5px;" id="profileName">Nama Pengguna</h3>
                                    <p style="color: var(--gray); margin-bottom: 5px;" id="profileEmail">email@example.com</p>
                                </div>
                                <div class="profile-edit-mode">
                                    <div class="profile-form-group">
                                        <label for="editName" class="required">Nama Penuh</label>
                                        <input type="text" id="editName" class="form-control" required>
                                    </div>
                                </div>
                                <button class="btn" id="changePasswordBtn" style="margin-top: 10px; font-size: 0.9rem; padding: 5px 15px;">
                                    <i class="fas fa-key"></i> Tukar Kata Laluan
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <!-- No. Kad Pengenalan -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">No. Kad Pengenalan</label>
                                <div class="profile-view-mode">
                                    <div class="profile-field-value" id="profileIC">000000000000</div>
                                </div>
                                <div class="profile-edit-mode">
                                    <div class="profile-field-edit">
                                        <input type="text" id="editIC" class="form-control auto-filled-field" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No. Telefon -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">No. Telefon</label>
                                <div class="profile-view-mode">
                                    <div class="profile-field-value" id="profilePhone">-</div>
                                </div>
                                <div class="profile-edit-mode">
                                    <div class="profile-field-edit">
                                        <input type="tel" id="editPhone" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Email -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">Alamat Email</label>
                                <div class="profile-view-mode">
                                    <div class="profile-field-value" id="profileEmailDisplay">email@example.com</div>
                                </div>
                                <div class="profile-edit-mode">
                                    <div class="profile-field-edit">
                                        <input type="email" id="editEmail" class="form-control" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alamat -->
                            <div style="grid-column: span 2;">
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">Alamat</label>
                                <div class="profile-view-mode">
                                    <div class="profile-field-value" id="profileAddress">-</div>
                                </div>
                                <div class="profile-edit-mode">
                                    <div class="profile-field-edit">
                                        <textarea id="editAddress" class="form-control" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ahli Sejak -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">Ahli Sejak</label>
                                <div class="profile-field-value" id="profileSince">-</div>
                            </div>
                            
                            <!-- Jumlah Permohonan -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--gray);">Jumlah Permohonan</label>
                                <div class="profile-field-value" id="profileTotalApps">0</div>
                            </div>
                        </div>
                        
                        <!-- Maklumat Tambahan -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--light-gray);">
                            <div class="profile-view-mode">
                                <h4 style="color: var(--primary); margin-bottom: 1rem;">Maklumat Tambahan</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--gray);">Status Akaun</label>
                                        <div class="profile-field-value" id="profileStatus">Aktif</div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--gray);">Peranan</label>
                                        <div class="profile-field-value" id="profileRole">Pengguna</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ... (Other pages remain the same) ... -->
            </div>
        </main>
        
        <!-- ... (Footer remains the same) ... -->
    </div>
    
    <!-- ... (Modals remain the same) ... -->

    <script>
        // ============================================
        // DATA STORAGE AND INITIALIZATION
        // ============================================
        
        const STORAGE_KEYS = {
            USERS: 'asset_rental_users',
            CURRENT_USER: 'current_asset_user',
            APPLICATIONS: 'user_applications',
            ASSETS: 'asset_data',
            VACANCIES: 'asset_vacancies',
            PASSWORD_RESET_TOKENS: 'password_reset_tokens',
            PROFILE_PICTURES: 'user_profile_pictures'
        };
        
        // ... (Other data remains the same) ...
        
        let currentUser = null;
        let users = [];
        let applications = [];
        let assets = [];
        let vacancies = VACANCY_DATA;
        let passwordResetTokens = {};
        let profilePictures = {};
        let isEditingProfile = false;
        let profilePictureFile = null;
        let profilePicturePreview = null;
        
        // Initialize System
        function initializeSystem() {
            // Initialize users
            const storedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
            if (!storedUsers) {
                users = DEMO_USERS;
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            } else {
                users = JSON.parse(storedUsers);
            }
            
            // Initialize applications
            const storedApps = localStorage.getItem(STORAGE_KEYS.APPLICATIONS);
            applications = storedApps ? JSON.parse(storedApps) : [];
            
            // Initialize assets
            const storedAssets = localStorage.getItem(STORAGE_KEYS.ASSETS);
            assets = storedAssets ? JSON.parse(storedAssets) : ASSETS_DATA;
            
            // Initialize vacancies
            const storedVacancies = localStorage.getItem(STORAGE_KEYS.VACANCIES);
            if (storedVacancies) {
                vacancies = JSON.parse(storedVacancies);
            } else {
                localStorage.setItem(STORAGE_KEYS.VACANCIES, JSON.stringify(vacancies));
            }
            
            // Initialize reset tokens
            const storedTokens = localStorage.getItem(STORAGE_KEYS.PASSWORD_RESET_TOKENS);
            passwordResetTokens = storedTokens ? JSON.parse(storedTokens) : {};
            
            // Initialize profile pictures
            const storedPictures = localStorage.getItem(STORAGE_KEYS.PROFILE_PICTURES);
            profilePictures = storedPictures ? JSON.parse(storedPictures) : {};
            
            // Check login status
            checkLoginStatus();
        }
        
        // ... (Authentication functions remain the same) ...
        
        // ============================================
        // PROFILE PICTURE FUNCTIONS
        // ============================================
        
        function loadProfilePicture(userId) {
            const profilePicture = document.getElementById('profilePicture');
            const placeholder = document.getElementById('profilePicturePlaceholder');
            const userAvatar = document.getElementById('userAvatar');
            const headerAvatar = document.getElementById('headerUserAvatar');
            
            if (profilePictures[userId]) {
                // Load saved profile picture
                const img = document.createElement('img');
                img.src = profilePictures[userId];
                img.alt = 'Gambar Profil';
                
                // Clear placeholder and add image
                if (profilePicture) {
                    profilePicture.innerHTML = '';
                    profilePicture.appendChild(img);
                }
                
                // Update avatars
                if (userAvatar) {
                    userAvatar.innerHTML = '';
                    const avatarImg = document.createElement('img');
                    avatarImg.src = profilePictures[userId];
                    avatarImg.alt = 'Avatar';
                    avatarImg.style.width = '100%';
                    avatarImg.style.height = '100%';
                    avatarImg.style.borderRadius = '50%';
                    userAvatar.appendChild(avatarImg);
                }
            } else {
                // Show initials as placeholder
                const user = users.find(u => u.id === userId);
                if (user && placeholder) {
                    placeholder.textContent = getInitials(user.name);
                }
                
                // Update avatars with initials
                if (userAvatar) {
                    userAvatar.textContent = getInitials(user ? user.name : '');
                }
            }
        }
        
        function saveProfilePicture(userId) {
            if (!profilePictureFile) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Save to localStorage
                profilePictures[userId] = e.target.result;
                localStorage.setItem(STORAGE_KEYS.PROFILE_PICTURES, JSON.stringify(profilePictures));
                
                // Update UI
                loadProfilePicture(userId);
                
                // Reset
                profilePictureFile = null;
                profilePicturePreview = null;
                
                // Hide actions
                const actions = document.getElementById('profilePictureActions');
                if (actions) actions.style.display = 'none';
                
                // Show success message
                alert('Gambar profil berjaya disimpan!');
            };
            reader.readAsDataURL(profilePictureFile);
        }
        
        function removeProfilePicture(userId) {
            if (confirm('Adakah anda pasti ingin membuang gambar profil?')) {
                delete profilePictures[userId];
                localStorage.setItem(STORAGE_KEYS.PROFILE_PICTURES, JSON.stringify(profilePictures));
                
                // Update UI
                loadProfilePicture(userId);
                
                // Reset
                profilePictureFile = null;
                profilePicturePreview = null;
                
                // Hide actions
                const actions = document.getElementById('profilePictureActions');
                if (actions) actions.style.display = 'none';
                
                alert('Gambar profil telah dibuang.');
            }
        }
        
        // ============================================
        // PROFILE EDIT FUNCTIONS
        // ============================================
        
        function startProfileEdit() {
            console.log("startProfileEdit called");
            
            isEditingProfile = true;
            
            // Add editing class to profile card
            const profileCard = document.getElementById('profileCard');
            if (profileCard) {
                profileCard.classList.add('editing');
            }
            
            // Show edit buttons, hide edit button
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (editBtn) editBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
            
            // Load current user data into edit fields
            const user = users.find(u => u.id === currentUser.id);
            if (user) {
                const editName = document.getElementById('editName');
                const editIC = document.getElementById('editIC');
                const editPhone = document.getElementById('editPhone');
                const editEmail = document.getElementById('editEmail');
                const editAddress = document.getElementById('editAddress');
                
                if (editName) editName.value = user.name;
                if (editIC) editIC.value = user.ic;
                if (editPhone) editPhone.value = user.phone || '';
                if (editEmail) editEmail.value = user.email;
                if (editAddress) editAddress.value = user.address || '';
            }
        }
        
        function cancelProfileEdit() {
            console.log("cancelProfileEdit called");
            
            isEditingProfile = false;
            
            // Remove editing class
            const profileCard = document.getElementById('profileCard');
            if (profileCard) {
                profileCard.classList.remove('editing');
            }
            
            // Show edit button, hide edit buttons
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (editBtn) editBtn.style.display = 'inline-flex';
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            // Clear validation messages
            clearValidationMessages();
        }
        
        function saveProfileChanges() {
            console.log("saveProfileChanges called");
            
            // Clear previous errors
            clearValidationMessages();
            
            const nameInput = document.getElementById('editName');
            const phoneInput = document.getElementById('editPhone');
            const emailInput = document.getElementById('editEmail');
            const addressInput = document.getElementById('editAddress');
            
            if (!nameInput || !emailInput) {
                alert('Ralat: Borang tidak lengkap');
                return;
            }
            
            const name = nameInput.value.trim();
            const phone = phoneInput ? phoneInput.value.trim() : '';
            const email = emailInput.value.trim();
            const address = addressInput ? addressInput.value.trim() : '';
            
            // Validation
            if (!name) {
                alert('Sila isi nama penuh');
                return;
            }
            
            if (!validateEmail(email)) {
                alert('Format email tidak sah');
                return;
            }
            
            // Check if email is already taken by another user
            const existingUser = users.find(u => u.email === email && u.id !== currentUser.id);
            if (existingUser) {
                alert('Email ini sudah digunakan oleh pengguna lain');
                return;
            }
            
            // Find and update user
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].phone = phone;
                users[userIndex].email = email;
                users[userIndex].address = address;
                
                // Update current user data
                currentUser.name = name;
                currentUser.phone = phone;
                currentUser.email = email;
                currentUser.address = address;
                
                // Save to storage
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                sessionStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                
                // Update UI
                updateUserInterface();
                loadUserDashboard();
                loadProfileData();
                
                // Exit edit mode
                cancelProfileEdit();
                
                // Show success message
                alert('Profil anda telah berjaya dikemaskini!');
            } else {
                alert('Ralat: Pengguna tidak ditemui');
            }
        }
        
        // ============================================
        // PROFILE DATA LOADING
        // ============================================
        
        function loadProfileData() {
            const user = users.find(u => u.id === currentUser.id);
            if (user) {
                // Update view mode
                document.getElementById('profileName').textContent = user.name;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileEmailDisplay').textContent = user.email;
                document.getElementById('profileIC').textContent = user.ic;
                document.getElementById('profilePhone').textContent = user.phone || 'Tiada';
                document.getElementById('profileAddress').textContent = user.address || 'Tiada';
                document.getElementById('profileSince').textContent = formatDate(user.createdAt);
                
                const userApps = applications.filter(app => app.applicantId === currentUser.id);
                document.getElementById('profileTotalApps').textContent = userApps.length;
                
                document.getElementById('profileStatus').textContent = user.status === 'active' ? 'Aktif' : 'Tidak Aktif';
                document.getElementById('profileRole').textContent = user.role === 'admin' ? 'Pentadbir' : 'Pengguna';
                
                // Load profile picture
                loadProfilePicture(currentUser.id);
            }
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update header
            const headerUserName = document.getElementById('headerUserName');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (headerUserName) headerUserName.textContent = currentUser.name;
            if (userName) userName.textContent = currentUser.name;
            
            // Update welcome message
            const welcomeTitle = document.getElementById('welcomeTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `Selamat Datang, ${currentUser.name.split(' ')[0]}!`;
            }
            
            // Update profile picture in header
            loadProfilePicture(currentUser.id);
            
            // Update navigation based on role
            updateNavigation();
        }
        
        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // ... (Authentication event listeners remain the same) ...
            
            // Profile edit buttons
            const editProfileBtn = document.getElementById('editProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            console.log("Edit Profile Button:", editProfileBtn);
            console.log("Save Profile Button:", saveProfileBtn);
            console.log("Cancel Edit Button:", cancelEditBtn);
            
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function(e) {
                    console.log("Edit profile button clicked!");
                    e.preventDefault();
                    startProfileEdit();
                });
            }
            
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', function(e) {
                    console.log("Save profile button clicked!");
                    e.preventDefault();
                    saveProfileChanges();
                });
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function(e) {
                    console.log("Cancel edit button clicked!");
                    e.preventDefault();
                    cancelProfileEdit();
                });
            }
            
            // Profile picture functionality
            const changeProfilePictureBtn = document.getElementById('changeProfilePictureBtn');
            const profilePictureInput = document.getElementById('profilePictureInput');
            const saveProfilePictureBtn = document.getElementById('saveProfilePictureBtn');
            const cancelProfilePictureBtn = document.getElementById('cancelProfilePictureBtn');
            
            if (changeProfilePictureBtn) {
                changeProfilePictureBtn.addEventListener('click', function() {
                    if (profilePictureInput) {
                        profilePictureInput.click();
                    }
                });
            }
            
            if (profilePictureInput) {
                profilePictureInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        profilePictureFile = e.target.files[0];
                        
                        // Validate file type
                        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                        if (!validTypes.includes(profilePictureFile.type)) {
                            alert('Hanya fail gambar dibenarkan (JPEG, PNG, GIF, WebP)');
                            profilePictureFile = null;
                            return;
                        }
                        
                        // Validate file size (max 2MB)
                        if (profilePictureFile.size > 2 * 1024 * 1024) {
                            alert('Saiz fail terlalu besar. Maksimum 2MB dibenarkan.');
                            profilePictureFile = null;
                            return;
                        }
                        
                        // Create preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            profilePicturePreview = e.target.result;
                            
                            // Update profile picture preview
                            const profilePicture = document.getElementById('profilePicture');
                            if (profilePicture) {
                                profilePicture.innerHTML = '';
                                const img = document.createElement('img');
                                img.src = profilePicturePreview;
                                img.alt = 'Pratonton Gambar';
                                profilePicture.appendChild(img);
                            }
                            
                            // Show action buttons
                            const actions = document.getElementById('profilePictureActions');
                            if (actions) actions.style.display = 'flex';
                        };
                        reader.readAsDataURL(profilePictureFile);
                    }
                });
            }
            
            if (saveProfilePictureBtn) {
                saveProfilePictureBtn.addEventListener('click', function() {
                    if (profilePictureFile) {
                        saveProfilePicture(currentUser.id);
                    } else {
                        alert('Sila pilih gambar terlebih dahulu');
                    }
                });
            }
            
            if (cancelProfilePictureBtn) {
                cancelProfilePictureBtn.addEventListener('click', function() {
                    // Reset to original picture
                    loadProfilePicture(currentUser.id);
                    
                    // Reset variables
                    profilePictureFile = null;
                    profilePicturePreview = null;
                    
                    // Hide actions
                    const actions = document.getElementById('profilePictureActions');
                    if (actions) actions.style.display = 'none';
                });
            }
            
            // Remove profile picture button
            const removeProfilePictureBtn = document.getElementById('removeProfilePictureBtn');
            if (removeProfilePictureBtn) {
                removeProfilePictureBtn.addEventListener('click', function() {
                    removeProfilePicture(currentUser.id);
                });
            }
            
            // ... (Other event listeners remain the same) ...
            
            console.log("Event listeners setup complete!");
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function getInitials(name) {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ms-MY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const selectedPage = document.getElementById(pageId);
            if (selectedPage) {
                selectedPage.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId.replace('Page', '')) {
                    link.classList.add('active');
                }
            });
            
            // Load page content
            if (pageId === 'dashboardPage') {
                loadDashboard();
            } else if (pageId === 'assetsPage') {
                loadAllAssets();
            } else if (pageId === 'applicationPage') {
                if (currentUser.role === 'admin') {
                    loadAdminApplications();
                } else {
                    loadUserApplications();
                }
            } else if (pageId === 'profilePage') {
                // Load profile data
                loadProfileData();
                // Reset edit mode if active
                if (isEditingProfile) {
                    cancelProfileEdit();
                }
                // Reset profile picture actions
                const actions = document.getElementById('profilePictureActions');
                if (actions) actions.style.display = 'none';
            } else if (pageId === 'usersPage') {
                loadUsersList();
            }
        }
        
        // ... (Other utility functions remain the same) ...
        
        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing system...");
            initializeSystem();
            setupEventListeners();
        });
    </script>
</body>
</html>
