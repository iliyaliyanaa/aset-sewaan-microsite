// ============================================
// ENHANCED POPULATE LOCATION DROPDOWN WITH ADD NEW OPTION
// ============================================

function populateLocationDropdown(assetType) {
    const locationSelect = document.getElementById('location');
    locationSelect.innerHTML = '<option value="">Sila Pilih Lokasi</option>';
    
    if (!assetType) {
        // Add "Add New Location" option even when no asset type selected
        addNewLocationOption(locationSelect);
        return;
    }
    
    // Get unique locations for this asset type
    const locations = [...new Set(assets
        .filter(asset => asset.type === assetType)
        .map(asset => asset.location.split(',')[0].trim())
    )];
    
    // Add locations to dropdown
    locations.forEach((location, index) => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        locationSelect.appendChild(option);
    });
    
    // Add "Add New Location" option at the end
    addNewLocationOption(locationSelect);
}

function addNewLocationOption(selectElement) {
    const addNewOption = document.createElement('option');
    addNewOption.value = "__add_new_location__";
    addNewOption.textContent = "âž• Tambah Lokasi Baru...";
    addNewOption.style.color = "#28a745";
    addNewOption.style.fontWeight = "bold";
    selectElement.appendChild(addNewOption);
}

// ============================================
// MODAL FOR ADDING NEW LOCATION
// ============================================

// Add this HTML before the closing </body> tag (tambah selepas modal success)
<div class="modal" id="addLocationModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="fas fa-map-marker-alt"></i> Tambah Lokasi Baru</h3>
            <button class="close-modal" onclick="closeModal('addLocationModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addLocationForm">
                <div class="form-group">
                    <label for="newLocationName" class="required">Nama Lokasi</label>
                    <input type="text" id="newLocationName" class="form-control" 
                           placeholder="Contoh: Kuala Perlis, Langkawi, etc" required>
                </div>
                
                <div class="form-group">
                    <label for="newLocationAddress">Alamat Lengkap</label>
                    <textarea id="newLocationAddress" class="form-control" rows="3" 
                              placeholder="No. Bangunan, Jalan, Poskod, Bandar..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newLocationState">Negeri</label>
                        <select id="newLocationState" class="form-control">
                            <option value="">Pilih Negeri</option>
                            <option value="perlis">Perlis</option>
                            <option value="kedah">Kedah</option>
                            <option value="pulau_pinang">Pulau Pinang</option>
                            <option value="perak">Perak</option>
                            <option value="selangor">Selangor</option>
                            <option value="wp_kuala_lumpur">W.P. Kuala Lumpur</option>
                            <option value="negeri_sembilan">Negeri Sembilan</option>
                            <option value="melaka">Melaka</option>
                            <option value="johor">Johor</option>
                            <option value="pahang">Pahang</option>
                            <option value="terengganu">Terengganu</option>
                            <option value="kelantan">Kelantan</option>
                            <option value="sabah">Sabah</option>
                            <option value="sarawak">Sarawak</option>
                            <option value="wp_labuan">W.P. Labuan</option>
                            <option value="wp_putrajaya">W.P. Putrajaya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newLocationPostcode">Poskod</label>
                        <input type="text" id="newLocationPostcode" class="form-control" 
                               placeholder="Contoh: 01000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newLocationNotes">Nota Tambahan (Jika Ada)</label>
                    <textarea id="newLocationNotes" class="form-control" rows="2" 
                              placeholder="Maklumat tambahan tentang lokasi ini..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="saveAsTemplate">
                        Simpan sebagai template untuk kegunaan masa depan
                    </label>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('addLocationModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Tambah Lokasi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Tambah CSS untuk custom dropdown */
.location-dropdown-container {
    position: relative;
}

.location-dropdown-actions {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 5px;
}

.location-dropdown-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: var(--gray);
    padding: 5px;
}

.location-dropdown-actions button:hover {
    color: var(--primary);
}
</style>

<script>
// ============================================
// ENHANCED LOCATION HANDLING FUNCTIONS
// ============================================

// Tambah event listener untuk location dropdown change
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced location dropdown handler
    document.getElementById('location').addEventListener('change', function() {
        handleLocationChange(this);
    });
    
    // Form untuk tambah lokasi baru
    document.getElementById('addLocationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveNewLocation();
    });
});

function handleLocationChange(selectElement) {
    if (selectElement.value === "__add_new_location__") {
        // Show add location modal
        showAddLocationModal();
        // Reset dropdown selection
        selectElement.value = "";
    }
}

function showAddLocationModal() {
    const modal = document.getElementById('addLocationModal');
    modal.style.display = 'flex';
    
    // Get current asset type untuk context
    const assetType = document.getElementById('assetType').value;
    const assetTypeText = document.getElementById('assetType').options[document.getElementById('assetType').selectedIndex].text;
    
    // Update modal title based on asset type
    if (assetTypeText) {
        modal.querySelector('h3').innerHTML = `<i class="fas fa-map-marker-alt"></i> Tambah Lokasi Baru untuk ${assetTypeText}`;
    }
    
    // Reset form
    document.getElementById('addLocationForm').reset();
}

function saveNewLocation() {
    const locationName = document.getElementById('newLocationName').value.trim();
    const address = document.getElementById('newLocationAddress').value.trim();
    const state = document.getElementById('newLocationState').value;
    const postcode = document.getElementById('newLocationPostcode').value.trim();
    const notes = document.getElementById('newLocationNotes').value.trim();
    const saveAsTemplate = document.getElementById('saveAsTemplate').checked;
    const assetType = document.getElementById('assetType').value;
    
    if (!locationName) {
        alert('Sila masukkan nama lokasi');
        document.getElementById('newLocationName').focus();
        return;
    }
    
    // Check if location already exists in current dropdown
    const locationSelect = document.getElementById('location');
    const existingOptions = Array.from(locationSelect.options)
        .map(opt => opt.textContent.toLowerCase().trim());
    
    if (existingOptions.includes(locationName.toLowerCase())) {
        alert(`Lokasi "${locationName}" sudah wujud dalam senarai. Sila pilih dari dropdown.`);
        closeModal('addLocationModal');
        return;
    }
    
    // Format full location string
    let fullLocation = locationName;
    if (address) fullLocation += `, ${address}`;
    if (state) fullLocation += `, ${state}`;
    if (postcode) fullLocation += `, ${postcode}`;
    
    // Add to assets array
    const newAsset = {
        id: assets.length + 100, // ID bermula dari 100 untuk custom locations
        type: assetType,
        name: `Custom: ${locationName}`,
        icon: "fas fa-map-marker-alt",
        color: "#1a5f7a",
        location: fullLocation,
        totalUnits: 1,
        availableUnits: 1,
        size: "Custom",
        monthlyRent: "RM 0",
        status: "available",
        description: notes || "Lokasi custom yang ditambah oleh pengguna",
        isCustom: true
    };
    
    assets.push(newAsset);
    localStorage.setItem(ASSETS_KEY, JSON.stringify(assets));
    
    // Add to dropdown (sebelum option "tambah baru")
    const newOption = document.createElement('option');
    newOption.value = locationName;
    newOption.textContent = locationName;
    newOption.selected = true;
    newOption.style.color = "#28a745";
    
    const addNewOption = locationSelect.querySelector('option[value="__add_new_location__"]');
    if (addNewOption) {
        locationSelect.insertBefore(newOption, addNewOption);
    } else {
        locationSelect.appendChild(newOption);
    }
    
    // Save as template jika dipilih
    if (saveAsTemplate) {
        saveLocationTemplate(locationName, assetType, fullLocation);
    }
    
    // Close modal
    closeModal('addLocationModal');
    
    // Show success message
    showNotification(`Lokasi "${locationName}" telah berjaya ditambah!`, 'success');
}

function saveLocationTemplate(locationName, assetType, fullLocation) {
    // Load existing templates
    let templates = JSON.parse(localStorage.getItem('location_templates') || '[]');
    
    // Check for duplicates
    if (!templates.some(t => t.name === locationName && t.type === assetType)) {
        const template = {
            id: Date.now(),
            name: locationName,
            type: assetType,
            location: fullLocation,
            createdAt: new Date().toISOString(),
            createdBy: currentUser ? currentUser.id : 'anonymous'
        };
        
        templates.push(template);
        localStorage.setItem('location_templates', JSON.stringify(templates));
    }
}

// ============================================
// PRE-POPULATED LOCATIONS BASED ON ASSET TYPE
// ============================================

// Enhanced populateLocationDropdown dengan lokasi pre-defined
const PREDEFINED_LOCATIONS = {
    'kuarters': [
        'Kuala Perlis',
        'Langkawi',
        'Kuala Kedah',
        'Padang Besar',
        'Bukit Kayu Hitam',
        'Bayan Permai',
        'Meru',
        'Camar Laut',
        'Cempaka Court',
        'Pengerang',
        'Sedili',
        'Mersing',
        'Endau',
        'Taman Guru',
        'Chendering',
        'Bachok',
        'Kuala Besar',
        'Geting',
        'Tanjun Manis',
        'Mukah',
        'Bintulu',
        'Miri',
        'Labuan'
    ],
    'pejabat': [
        'Kuala Lumpur Pusat',
        'Petaling Jaya',
        'Shah Alam',
        'Subang Jaya',
        'Cyberjaya',
        'Putrajaya'
    ],
    'tanah': [
        'Lot Perindustrian',
        'Lot Komersial',
        'Lot Pertanian',
        'Lot Kosong'
    ],
    'rumah_rehat': [
        'Cameron Highlands',
        'Genting Highlands',
        'Fraser\'s Hill',
        'Port Dickson',
        'Pulau Pangkor'
    ],
    'kedai': [
        'Kompleks Perniagaan',
        'Pusat Komersial',
        'Pasaraya',
        'Pasar Malam'
    ],
    'bilik': [
        'Asrama Kerajaan',
        'Asrama Kakitangan',
        'Rumah Tumpangan'
    ]
};

// Fungsi yang telah dikemaskini dengan predefined locations
function populateLocationDropdown(assetType) {
    const locationSelect = document.getElementById('location');
    locationSelect.innerHTML = '<option value="">Sila Pilih Lokasi</option>';
    
    if (!assetType) {
        addNewLocationOption(locationSelect);
        return;
    }
    
    // Step 1: Get locations from existing assets
    const existingLocations = [...new Set(assets
        .filter(asset => asset.type === assetType)
        .map(asset => asset.location.split(',')[0].trim())
    )];
    
    // Step 2: Get predefined locations for this asset type
    const predefinedLocations = PREDEFINED_LOCATIONS[assetType] || [];
    
    // Step 3: Combine and deduplicate
    const allLocations = [...new Set([...existingLocations, ...predefinedLocations])].sort();
    
    // Step 4: Add to dropdown
    allLocations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        
        // Mark predefined locations
        if (predefinedLocations.includes(location) && !existingLocations.includes(location)) {
            option.style.fontStyle = 'italic';
            option.style.color = '#6c757d';
            option.title = 'Lokasi sedia ada';
        }
        
        locationSelect.appendChild(option);
    });
    
    // Step 5: Add "Add New Location" option
    addNewLocationOption(locationSelect);
}

// ============================================
// QUICK LOCATION ADD FUNCTION
// ============================================

function quickAddLocation(locationName) {
    const assetType = document.getElementById('assetType').value;
    const locationSelect = document.getElementById('location');
    
    if (!assetType) {
        alert('Sila pilih jenis aset dahulu');
        return;
    }
    
    if (!locationName || locationName.trim() === '') {
        alert('Sila masukkan nama lokasi');
        return;
    }
    
    // Check if already exists
    const existingOptions = Array.from(locationSelect.options)
        .map(opt => opt.textContent.toLowerCase().trim());
    
    if (existingOptions.includes(locationName.toLowerCase())) {
        // Select existing location
        for (let i = 0; i < locationSelect.options.length; i++) {
            if (locationSelect.options[i].textContent.toLowerCase() === locationName.toLowerCase()) {
                locationSelect.value = locationSelect.options[i].value;
                break;
            }
        }
        return;
    }
    
    // Add to dropdown
    const newOption = document.createElement('option');
    newOption.value = locationName;
    newOption.textContent = locationName;
    newOption.selected = true;
    newOption.style.color = '#28a745';
    
    const addNewOption = locationSelect.querySelector('option[value="__add_new_location__"]');
    if (addNewOption) {
        locationSelect.insertBefore(newOption, addNewOption);
    } else {
        locationSelect.appendChild(newOption);
    }
    
    // Show success notification
    showNotification(`Lokasi "${locationName}" telah ditambah`, 'success');
}

// ============================================
// UPDATE EVENT LISTENER UNTUK ASSET TYPE
// ============================================

// Dalam setupEventListeners(), update asset type change listener:
document.getElementById('assetType').addEventListener('change', function() {
    const locationSelect = document.getElementById('location');
    
    // Store the "add new location" functionality
    const preserveAddNew = locationSelect.innerHTML.includes('__add_new_location__');
    
    // Populate dropdown
    populateLocationDropdown(this.value);
    
    // If there was an "add new" option, ensure it's preserved
    if (preserveAddNew && !locationSelect.innerHTML.includes('__add_new_location__')) {
        addNewLocationOption(locationSelect);
    }
});

// ============================================
// ENHANCED APPLICATION FORM WITH LOCATION NOTES
// ============================================

// Tambah field untuk location notes dalam application form
// (Tambah selepas location dropdown dalam modal application)

function enhanceApplicationForm() {
    const locationFieldContainer = document.getElementById('location').parentNode;
    
    // Tambah quick action buttons
    const quickActionsDiv = document.createElement('div');
    quickActionsDiv.className = 'location-dropdown-actions';
    quickActionsDiv.innerHTML = `
        <button type="button" onclick="showAddLocationModal()" title="Tambah Lokasi Baru">
            <i class="fas fa-plus"></i>
        </button>
        <button type="button" onclick="refreshLocations()" title="Refresh Senarai Lokasi">
            <i class="fas fa-sync-alt"></i>
        </button>
    `;
    
    // Wrap location select dengan container
    const containerDiv = document.createElement('div');
    containerDiv.className = 'location-dropdown-container';
    containerDiv.appendChild(document.getElementById('location'));
    containerDiv.appendChild(quickActionsDiv);
    
    locationFieldContainer.appendChild(containerDiv);
    
    // Tambah field untuk location notes
    const notesDiv = document.createElement('div');
    notesDiv.className = 'form-group';
    notesDiv.style.display = 'none'; // Initially hidden
    notesDiv.id = 'locationNotesContainer';
    notesDiv.innerHTML = `
        <label for="locationNotes">Nota Lokasi</label>
        <textarea id="locationNotes" class="form-control" rows="2" 
                  placeholder="Maklumat tambahan tentang lokasi pilihan..."></textarea>
    `;
    
    locationFieldContainer.appendChild(notesDiv);
    
    // Show notes when location is selected
    document.getElementById('location').addEventListener('change', function() {
        const notesContainer = document.getElementById('locationNotesContainer');
        if (this.value && this.value !== "__add_new_location__") {
            notesContainer.style.display = 'block';
        } else {
            notesContainer.style.display = 'none';
        }
    });
}

function refreshLocations() {
    const assetType = document.getElementById('assetType').value;
    populateLocationDropdown(assetType);
    showNotification('Senarai lokasi telah dikemas kini', 'info');
}

// Panggil fungsi ini dalam initialization
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(enhanceApplicationForm, 100);
});
</script>
