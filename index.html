<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Aset Sewaan - Portal Utama</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS tetap sama seperti sebelumnya) ... */
    </style>
</head>
<body>
    <!-- Authentication Pages (tetap sama) -->
    
    <!-- Main Application (tetap sama) -->
    
    <!-- Modal Borang Kuarters (dikemaskini) -->
    <div class="modal" id="borangKuartersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-home"></i> Borang Permohonan Kuarters</h3>
                <button class="close-modal" data-modal="borangKuartersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="status-indicator" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 15px; background-color: rgba(26, 95, 122, 0.05); border-radius: 8px;">
                    <div class="status-dot-indicator" style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--success);"></div>
                    <span>Sila lengkapkan semua maklumat yang diperlukan</span>
                </div>
                
                <!-- Info Pemohon -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-tie"></i> MAKLUMAT PEMOHON</h3>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Maklumat pemohon akan diisi secara automatik dari data profil anda</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Nama Penuh Pemohon</label>
                            <input type="text" class="form-control" id="namaPemohon" required readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">No. Kad Pengenalan / No. Pekerja</label>
                            <input type="text" class="form-control" id="noKP" required readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Jawatan / Gred</label>
                            <select class="form-control" id="gredJawatan" required>
                                <option value="">Sila pilih gred</option>
                                <option value="JUSA">JUSA</option>
                                <option value="N54">N54 (Pengarah)</option>
                                <option value="N48">N48 (Timbalan Pengarah)</option>
                                <option value="N44">N44 (Ketua Penolong Pengarah)</option>
                                <option value="N41">N41 (Penolong Pengarah)</option>
                                <option value="F41">F41 (Jurutera)</option>
                                <option value="F38">F38 (Penolong Jurutera)</option>
                                <option value="S41">S41 (Pegawai Perubatan)</option>
                                <option value="S38">S38 (Penolong Pegawai Perubatan)</option>
                                <option value="M41">M41 (Pegawai Tadbir)</option>
                                <option value="M38">M38 (Penolong Pegawai Tadbir)</option>
                                <option value="W41">W41 (Pegawai Teknologi Maklumat)</option>
                                <option value="W38">W38 (Penolong Pegawai Teknologi Maklumat)</option>
                                <option value="A29">A29 (Pembantu Tadbir)</option>
                                <option value="A19">A19 (Pembantu Am Pejabat)</option>
                                <option value="R14">R14 (Pemandu)</option>
                            </select>
                            <small>Pilihan gred akan menentukan kelas kuarters yang layak</small>
                        </div>
                        <div class="form-group">
                            <label class="required">Kementerian / Jabatan</label>
                            <input type="text" class="form-control" id="jabatan" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Alamat Kem / Jabatan</label>
                        <textarea class="form-control" id="alamatJabatan" rows="3" required placeholder="Contoh: Jabatan Kerja Raya, Tingkat 12, Wisma Kerja Raya, Jalan Sultan Salahuddin, 50582 Kuala Lumpur"></textarea>
                        <small>Sila masukkan alamat lengkap termasuk negeri</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Jarak Kuarters ke Tempat Kerja (km)</label>
                            <input type="number" class="form-control" id="jarakKerja" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Negeri dikesan dari alamat:</label>
                            <input type="text" class="form-control" id="negeriDikesan" readonly style="background-color: #f8f9fa; color: var(--success); font-weight: bold;">
                            <small>Kuarters akan ditapis berdasarkan negeri ini</small>
                        </div>
                    </div>
                </div>
                
                <!-- Maklumat Keluarga -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-users"></i> MAKLUMAT KELUARGA</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Status Perkahwinan</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="statusKahwin" name="statusPerkahwinan" value="Berkahwin" required>
                                    <label for="statusKahwin">Berkahwin</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusTidakKahwin" name="statusPerkahwinan" value="Tidak Berkahwin">
                                    <label for="statusTidakKahwin">Tidak Berkahwin</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusBujang" name="statusPerkahwinan" value="Bujang">
                                    <label for="statusBujang">Bujang</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required">Jumlah Tanggungan</label>
                            <select class="form-control" id="jumlahTanggungan" required>
                                <option value="">Sila pilih</option>
                                <option value="0">Tiada</option>
                                <option value="1">1 orang</option>
                                <option value="2">2 orang</option>
                                <option value="3">3 orang</option>
                                <option value="4">4 orang</option>
                                <option value="5">5 orang atau lebih</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Maklumat Kuarters -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-home"></i> MAKLUMAT KUARTERS</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Kelas Kuarters</label>
                            <input type="text" class="form-control" id="kelasKuarters" readonly>
                            <small>Ditentukan secara automatik berdasarkan gred jawatan</small>
                        </div>
                        <div class="form-group">
                            <label class="required">Unit Kuarters</label>
                            <select class="form-control" id="unitKuarters" required disabled>
                                <option value="">Sila isi alamat dan pilih gred dahulu</option>
                            </select>
                            <small>Unit akan ditapis berdasarkan negeri dalam alamat jabatan</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Tarikh Masuk Rumah Diharapkan</label>
                            <input type="date" class="form-control" id="tarikhMasuk" required>
                            <small>Tarikh anda bercadang untuk memasuki kuarters</small>
                        </div>
                    </div>
                    
                    <!-- PREVIEW KUARTERS -->
                    <div class="kuarters-preview-container" style="margin-top: 25px; border: 1px solid var(--light-gray); border-radius: 8px; overflow: hidden; background-color: var(--light);">
                        <div class="preview-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="font-size: 1.2rem; margin: 0;"><i class="fas fa-eye"></i> PREVIEW KUARTERS YANG LAYAK</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="previewCount" style="font-size: 0.9rem; opacity: 0.9;">Tiada unit ditemui</span>
                                <button class="preview-refresh" id="refreshPreview" title="Refresh preview" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="kuarters-preview-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 300px;">
                            <div class="kuarters-image-container" style="padding: 20px; display: flex; align-items: center; justify-content: center; background-color: white;">
                                <div class="kuarters-image" id="kuartersImage" style="width: 100%; max-width: 350px; height: 250px; background-color: var(--light-gray); border-radius: 8px; overflow: hidden; position: relative;">
                                    <div class="image-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--gray); text-align: center; padding: 20px;">
                                        <i class="fas fa-home" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                        <p>Isi alamat jabatan dan pilih gred untuk melihat kuarters yang tersedia</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kuarters-details" style="padding: 20px; background-color: white;">
                                <div class="detail-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Kelas Kuarters:</span>
                                        <span class="detail-value">
                                            <span class="kuarters-class-badge" id="previewKelas" style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; margin-right: 5px;">-</span>
                                        </span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Gred Layak:</span>
                                        <span class="detail-value" id="previewGred" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Luas Keluasan:</span>
                                        <span class="detail-value" id="previewLuas" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Bilangan Bilik:</span>
                                        <span class="detail-value" id="previewBilik" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Kemudahan:</span>
                                        <span class="detail-value" id="previewKemudahan" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Sewa Bulanan:</span>
                                        <span class="detail-value" id="previewSewa" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Status Unit:</span>
                                        <span class="detail-value">
                                            <span class="availability-status" id="previewStatus" style="display: inline-flex; align-items: center; gap: 8px; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                                <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                                <span id="statusText">-</span>
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detail-item" style="display: flex; flex-direction: column;">
                                        <span class="detail-label" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 5px;">Lokasi:</span>
                                        <span class="detail-value" id="previewLokasi" style="font-weight: 500; font-size: 0.95rem;">-</span>
                                    </div>
                                </div>
                                
                                <!-- Unit Tersedia untuk Negeri -->
                                <div id="unitsContainer" style="margin-top: 20px; display: none;">
                                    <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 1rem;">
                                        <i class="fas fa-list"></i> Unit Tersedia di <span id="negeriDisplay"></span>:
                                    </h5>
                                    <div id="unitsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; background-color: rgba(26, 95, 122, 0.05); border-radius: 6px;">
                                        <!-- Units akan dipaparkan di sini -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="background-color: rgba(26, 95, 122, 0.05); border-radius: 8px; padding: 15px; margin-top: 20px; border-left: 4px solid var(--primary);">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 1rem;"><i class="fas fa-info-circle"></i> Maklumat Penting</h4>
                        <ul style="padding-left: 20px; font-size: 0.9rem; color: var(--gray);">
                            <li>Kelas kuarters ditentukan berdasarkan gred jawatan</li>
                            <li>Unit kuarters akan ditapis secara automatik berdasarkan negeri dalam alamat jabatan</li>
                            <li>Hanya unit yang berstatus "Tersedia" boleh dipilih</li>
                            <li>Sistem akan mengesan negeri dari alamat yang anda masukkan</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Justifikasi dan tarikh (tetap sama) -->
                
                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn" id="btnBatalKuarters">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="button" class="btn btn-primary" id="btnHantarKuarters">
                        <i class="fas fa-paper-plane"></i> Hantar Permohonan
                    </button>
                </div>
                
                <div class="spinner" id="loadingSpinner"></div>
            </div>
        </div>
    </div>

    <!-- Success Modal (tetap sama) -->

    <script>
        // ============================================
        // DATA STORAGE AND INITIALIZATION
        // ============================================
        
        const STORAGE_KEYS = {
            USERS: 'asset_rental_users',
            CURRENT_USER: 'current_asset_user',
            APPLICATIONS: 'user_applications'
        };
        
        const DEMO_USERS = [
            {
                id: 1,
                name: "Ali bin Ahmad",
                ic: "850505011234",
                email: "ali@email.com",
                phone: "0123456789",
                password: "password123",
                address: "No 123, Jalan Bunga, 43000 Kajang, Selangor",
                createdAt: "2023-10-01",
                role: "user"
            }
        ];
        
        // Data kuarters berdasarkan kelas dan negeri
        const KUARTERS_DATA = {
            'A': {
                name: 'Kelas A',
                color: 'class-a',
                gred: ['JUSA', 'N54'],
                luas: '1800-2200 kaki persegi',
                bilik: '4-5 bilik',
                kemudahan: '3 bilik air, dapur moden, parking 2 kereta, aircond',
                sewa: 'RM 450-550',
                lokasi: 'Kawasan VIP, berhampiran pejabat utama',
                image: 'https://images.unsplash.com/photo-1518780664697-55e3ad937233?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                units: [
                    { id: 'KA001', name: 'Kuarters A1 - Blok A', status: 'available', negeri: 'Kuala Lumpur', lokasi: 'Jalan Duta' },
                    { id: 'KA002', name: 'Kuarters A2 - Blok A', status: 'available', negeri: 'Kuala Lumpur', lokasi: 'Jalan Duta' },
                    { id: 'KA003', name: 'Kuarters A3 - Blok B', status: 'occupied', negeri: 'Putrajaya', lokasi: 'Presint 5' },
                    { id: 'KA004', name: 'Kuarters A4 - Blok B', status: 'available', negeri: 'Putrajaya', lokasi: 'Presint 5' },
                    { id: 'KA005', name: 'Kuarters A5 - Blok C', status: 'available', negeri: 'Selangor', lokasi: 'Shah Alam' },
                    { id: 'KA006', name: 'Kuarters A6 - Blok C', status: 'available', negeri: 'Selangor', lokasi: 'Shah Alam' }
                ]
            },
            'B': {
                name: 'Kelas B',
                color: 'class-b',
                gred: ['N48', 'N44', 'F41', 'S41'],
                luas: '1500-1800 kaki persegi',
                bilik: '3-4 bilik',
                kemudahan: '2 bilik air, dapur, parking 2 kereta, kipas siling',
                sewa: 'RM 350-450',
                lokasi: 'Kawasan tengah, berhampiran kemudahan awam',
                image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                units: [
                    { id: 'KB001', name: 'Kuarters B1 - Blok C', status: 'available', negeri: 'Johor', lokasi: 'Johor Bahru' },
                    { id: 'KB002', name: 'Kuarters B2 - Blok C', status: 'occupied', negeri: 'Johor', lokasi: 'Johor Bahru' },
                    { id: 'KB003', name: 'Kuarters B3 - Blok D', status: 'available', negeri: 'Pulau Pinang', lokasi: 'Georgetown' },
                    { id: 'KB004', name: 'Kuarters B4 - Blok D', status: 'occupied', negeri: 'Pulau Pinang', lokasi: 'Georgetown' },
                    { id: 'KB005', name: 'Kuarters B5 - Blok E', status: 'available', negeri: 'Perak', lokasi: 'Ipoh' },
                    { id: 'KB006', name: 'Kuarters B6 - Blok E', status: 'available', negeri: 'Kedah', lokasi: 'Alor Setar' },
                    { id: 'KB007', name: 'Kuarters B7 - Blok F', status: 'available', negeri: 'Kelantan', lokasi: 'Kota Bharu' },
                    { id: 'KB008', name: 'Kuarters B8 - Blok F', status: 'available', negeri: 'Terengganu', lokasi: 'Kuala Terengganu' }
                ]
            },
            'C': {
                name: 'Kelas C',
                color: 'class-c',
                gred: ['N41', 'F38', 'S38', 'M41', 'W41'],
                luas: '1200-1500 kaki persegi',
                bilik: '3 bilik',
                kemudahan: '2 bilik air, dapur, parking 1 kereta',
                sewa: 'RM 250-350',
                lokasi: 'Kawasan luar, 5 minit ke pejabat',
                image: 'https://images.unsplash.com/photo-1558036117-15e82a2c9a9a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                units: [
                    { id: 'KC001', name: 'Kuarters C1 - Blok F', status: 'available', negeri: 'Negeri Sembilan', lokasi: 'Seremban' },
                    { id: 'KC002', name: 'Kuarters C2 - Blok F', status: 'available', negeri: 'Negeri Sembilan', lokasi: 'Seremban' },
                    { id: 'KC003', name: 'Kuarters C3 - Blok G', status: 'occupied', negeri: 'Melaka', lokasi: 'Bandaraya Melaka' },
                    { id: 'KC004', name: 'Kuarters C4 - Blok G', status: 'available', negeri: 'Melaka', lokasi: 'Bandaraya Melaka' },
                    { id: 'KC005', name: 'Kuarters C5 - Blok H', status: 'available', negeri: 'Pahang', lokasi: 'Kuantan' },
                    { id: 'KC006', name: 'Kuarters C6 - Blok H', status: 'occupied', negeri: 'Pahang', lokasi: 'Kuantan' },
                    { id: 'KC007', name: 'Kuarters C7 - Blok I', status: 'available', negeri: 'Sabah', lokasi: 'Kota Kinabalu' },
                    { id: 'KC008', name: 'Kuarters C8 - Blok I', status: 'available', negeri: 'Sarawak', lokasi: 'Kuching' }
                ]
            },
            'D': {
                name: 'Kelas D',
                color: 'class-d',
                gred: ['M38', 'W38', 'A29', 'A19', 'R14'],
                luas: '800-1200 kaki persegi',
                bilik: '2 bilik',
                kemudahan: '1 bilik air, dapur kecil, parking 1 kereta',
                sewa: 'RM 150-250',
                lokasi: 'Kawasan asrama, berhampiran pintu masuk',
                image: 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                units: [
                    { id: 'KD001', name: 'Kuarters D1 - Blok I', status: 'available', negeri: 'Kuala Lumpur', lokasi: 'Setapak' },
                    { id: 'KD002', name: 'Kuarters D2 - Blok I', status: 'occupied', negeri: 'Kuala Lumpur', lokasi: 'Setapak' },
                    { id: 'KD003', name: 'Kuarters D3 - Blok J', status: 'available', negeri: 'Selangor', lokasi: 'Klang' },
                    { id: 'KD004', name: 'Kuarters D4 - Blok J', status: 'available', negeri: 'Selangor', lokasi: 'Klang' },
                    { id: 'KD005', name: 'Kuarters D5 - Blok K', status: 'occupied', negeri: 'Johor', lokasi: 'Batu Pahat' },
                    { id: 'KD006', name: 'Kuarters D6 - Blok K', status: 'available', negeri: 'Johor', lokasi: 'Batu Pahat' },
                    { id: 'KD007', name: 'Kuarters D7 - Blok L', status: 'available', negeri: 'Perak', lokasi: 'Taiping' },
                    { id: 'KD008', name: 'Kuarters D8 - Blok L', status: 'available', negeri: 'Pulau Pinang', lokasi: 'Butterworth' }
                ]
            }
        };

        // Pemetaan gred ke kelas kuarters
        const GRED_TO_CLASS = {
            'JUSA': 'A',
            'N54': 'A',
            'N48': 'B',
            'N44': 'B',
            'F41': 'B',
            'S41': 'B',
            'N41': 'C',
            'F38': 'C',
            'S38': 'C',
            'M41': 'C',
            'W41': 'C',
            'M38': 'D',
            'W38': 'D',
            'A29': 'D',
            'A19': 'D',
            'R14': 'D'
        };

        // Senarai negeri di Malaysia untuk pengesanan
        const NEGERI_MALAYSIA = [
            'Johor', 'Kedah', 'Kelantan', 'Melaka', 'Negeri Sembilan',
            'Pahang', 'Perak', 'Perlis', 'Pulau Pinang', 'Sabah',
            'Sarawak', 'Selangor', 'Terengganu', 'Kuala Lumpur',
            'Labuan', 'Putrajaya'
        ];
        
        let currentUser = null;
        let users = [];
        let applications = [];
        let currentNegeri = '';
        let availableUnits = [];
        
        // Initialize System
        function initializeSystem() {
            console.log("Initializing system...");
            
            // Initialize users
            const storedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
            if (!storedUsers) {
                users = DEMO_USERS;
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            } else {
                users = JSON.parse(storedUsers);
            }
            
            // Initialize applications
            const storedApps = localStorage.getItem(STORAGE_KEYS.APPLICATIONS);
            applications = storedApps ? JSON.parse(storedApps) : [];
            
            // Check login status
            const storedUser = sessionStorage.getItem(STORAGE_KEYS.CURRENT_USER) || 
                              localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    showApplication();
                    console.log("User logged in:", currentUser.name);
                } catch (e) {
                    showAuthentication();
                }
            } else {
                showAuthentication();
            }
            
            setupEventListeners();
        }
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        function showAuthentication() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            switchAuthTab('login');
        }
        
        function showApplication() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateUserInterface();
            loadDashboard();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            const user = users.find(u => 
                u.email === identifier || u.ic === identifier
            );
            
            if (!user) {
                alert('Akaun tidak ditemui');
                return;
            }
            
            if (user.password !== password) {
                alert('Kata laluan tidak betul');
                return;
            }
            
            currentUser = {
                id: user.id,
                name: user.name,
                email: user.email,
                phone: user.phone,
                ic: user.ic,
                address: user.address,
                role: user.role,
                createdAt: user.createdAt
            };
            
            sessionStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
            if (rememberMe) {
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
            }
            
            showApplication();
        }
        
        function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const ic = document.getElementById('registerIC').value;
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            
            // Check if user already exists
            if (users.find(u => u.email === email)) {
                alert('Email sudah didaftarkan');
                return;
            }
            
            const userData = {
                id: Date.now(),
                name: name,
                ic: ic,
                email: email,
                phone: phone,
                password: password,
                address: '',
                createdAt: new Date().toISOString().split('T')[0],
                role: 'user'
            };
            
            users.push(userData);
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            
            alert('Pendaftaran berjaya! Sila log masuk.');
            switchAuthTab('login');
        }
        
        // ============================================
        // FUNGSI PENGESANAN NEGERI
        // ============================================
        
        function detectNegeriFromAddress(alamat) {
            if (!alamat) return '';
            
            const alamatLower = alamat.toLowerCase();
            
            // Cari negeri dalam alamat
            for (const negeri of NEGERI_MALAYSIA) {
                const negeriLower = negeri.toLowerCase();
                if (alamatLower.includes(negeriLower)) {
                    return negeri;
                }
            }
            
            // Jika tidak jumpa, cuba cari kod pos (contoh: 43000 untuk Kajang, Selangor)
            const kodPosPattern = /\b(\d{5})\b/;
            const kodPosMatch = alamat.match(kodPosPattern);
            
            if (kodPosMatch) {
                const kodPos = kodPosMatch[1];
                // Pemetaan kod pos ke negeri (contoh ringkas)
                const kodPosToNegeri = {
                    '43000': 'Selangor',
                    '50000': 'Kuala Lumpur',
                    '80000': 'Johor',
                    '10000': 'Pulau Pinang',
                    '30000': 'Perak',
                    '75000': 'Melaka',
                    '70000': 'Negeri Sembilan',
                    '25000': 'Pahang',
                    '05000': 'Kedah',
                    '15000': 'Kelantan',
                    '20000': 'Terengganu',
                    '88000': 'Sabah',
                    '93000': 'Sarawak'
                };
                
                if (kodPosToNegeri[kodPos]) {
                    return kodPosToNegeri[kodPos];
                }
            }
            
            return '';
        }
        
        // ============================================
        // BORANG KUARTERS FUNCTIONS
        // ============================================
        
        function initializeKuartersForm() {
            try {
                if (currentUser) {
                    document.getElementById('namaPemohon').value = currentUser.name || '';
                    document.getElementById('noKP').value = currentUser.ic || '';
                    
                    // Auto-generate reference number
                    const refNumber = `KUARTERS-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`;
                    document.getElementById('noRujukan').textContent = refNumber;
                }
            } catch (e) {
                console.error('Error loading user data:', e);
            }
            
            // Set today's date as application date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tarikhMohon').value = formatDate(today);
            
            // Set minimum date for tarikh masuk (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('tarikhMasuk').min = tomorrowStr;
            document.getElementById('tarikhMasuk').value = tomorrowStr;
            
            // Initialize preview status
            resetPreview();
            
            // Clear previous data
            document.getElementById('negeriDikesan').value = '';
            currentNegeri = '';
            availableUnits = [];
            hideUnitsList();
        }
        
        function updateKuartersClass() {
            const gred = document.getElementById('gredJawatan').value;
            const kelasKuarters = document.getElementById('kelasKuarters');
            const unitSelect = document.getElementById('unitKuarters');
            
            if (gred && GRED_TO_CLASS[gred]) {
                const kelas = GRED_TO_CLASS[gred];
                const kelasData = KUARTERS_DATA[kelas];
                
                kelasKuarters.value = kelasData.name;
                
                // Enable unit selection if negeri sudah dikesan
                if (currentNegeri) {
                    unitSelect.disabled = false;
                    filterUnitsByNegeri(kelas, currentNegeri);
                } else {
                    unitSelect.disabled = true;
                    unitSelect.innerHTML = '<option value="">Sila isi alamat jabatan terlebih dahulu</option>';
                }
                
                // Update preview
                updateKuartersPreview();
            } else {
                kelasKuarters.value = '';
                unitSelect.disabled = true;
                unitSelect.innerHTML = '<option value="">Sila pilih gred dahulu</option>';
            }
        }
        
        function filterUnitsByNegeri(kelas, negeri) {
            const kelasData = KUARTERS_DATA[kelas];
            const unitSelect = document.getElementById('unitKuarters');
            
            // Filter units berdasarkan negeri
            availableUnits = kelasData.units.filter(unit => 
                unit.negeri === negeri && unit.status === 'available'
            );
            
            // Update dropdown
            unitSelect.innerHTML = '<option value="">Sila pilih unit</option>';
            
            if (availableUnits.length === 0) {
                unitSelect.innerHTML = '<option value="">Tiada unit tersedia di negeri ini</option>';
                unitSelect.disabled = true;
                hideUnitsList();
            } else {
                unitSelect.disabled = false;
                availableUnits.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = `${unit.name} - ${unit.lokasi}`;
                    unitSelect.appendChild(option);
                });
                
                // Show units list
                displayUnitsList(availableUnits, negeri);
            }
            
            // Update preview count
            document.getElementById('previewCount').textContent = 
                `${availableUnits.length} unit tersedia di ${negeri}`;
        }
        
        function displayUnitsList(units, negeri) {
            const unitsContainer = document.getElementById('unitsContainer');
            const unitsList = document.getElementById('unitsList');
            const negeriDisplay = document.getElementById('negeriDisplay');
            
            if (units.length === 0) {
                hideUnitsList();
                return;
            }
            
            // Set negeri display
            negeriDisplay.textContent = negeri;
            
            // Clear previous list
            unitsList.innerHTML = '';
            
            // Display each unit
            units.forEach(unit => {
                const unitItem = document.createElement('div');
                unitItem.className = 'unit-item';
                unitItem.style.cssText = `
                    background-color: white;
                    border: 1px solid var(--light-gray);
                    border-radius: 6px;
                    padding: 8px 12px;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                
                unitItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${unit.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--gray);">${unit.lokasi}</div>
                        </div>
                        <span class="availability-status available" style="font-size: 0.75rem;">
                            <span class="status-dot"></span> Tersedia
                        </span>
                    </div>
                `;
                
                // Add click event to select unit
                unitItem.addEventListener('click', () => {
                    document.getElementById('unitKuarters').value = unit.id;
                    updateKuartersPreview();
                    highlightSelectedUnit(unit.id);
                });
                
                unitsList.appendChild(unitItem);
            });
            
            // Show container
            unitsContainer.style.display = 'block';
            
            // Highlight selected unit if any
            const selectedUnit = document.getElementById('unitKuarters').value;
            if (selectedUnit) {
                highlightSelectedUnit(selectedUnit);
            }
        }
        
        function hideUnitsList() {
            document.getElementById('unitsContainer').style.display = 'none';
            document.getElementById('unitsList').innerHTML = '';
        }
        
        function highlightSelectedUnit(unitId) {
            const unitItems = document.querySelectorAll('.unit-item');
            unitItems.forEach(item => {
                item.style.backgroundColor = 'white';
                item.style.borderColor = 'var(--light-gray)';
            });
            
            const selectedItem = Array.from(unitItems).find(item => {
                const unitText = item.querySelector('strong').textContent;
                return unitText.includes(unitId);
            });
            
            if (selectedItem) {
                selectedItem.style.backgroundColor = 'rgba(26, 95, 122, 0.1)';
                selectedItem.style.borderColor = 'var(--primary)';
            }
        }
        
        function updateKuartersPreview(forceRefresh = false) {
            const gred = document.getElementById('gredJawatan').value;
            const unitId = document.getElementById('unitKuarters').value;
            
            if (!gred || !GRED_TO_CLASS[gred]) {
                resetPreview();
                return;
            }
            
            const kelas = GRED_TO_CLASS[gred];
            const kelasData = KUARTERS_DATA[kelas];
            
            // Update image
            const imageContainer = document.getElementById('kuartersImage');
            if (imageContainer) {
                imageContainer.innerHTML = `
                    <img src="${kelasData.image}${forceRefresh ? '&' : '?'}refresh=${Date.now()}" 
                         alt="${kelasData.name}" 
                         style="width:100%; height:100%; object-fit:cover;"
                         onerror="this.onerror=null; this.src=''; this.parentElement.innerHTML='<div class=\"image-placeholder\" style=\"display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--gray); text-align: center; padding: 20px;\"><i class=\"fas fa-home\" style=\"font-size: 3rem; margin-bottom: 10px; opacity: 0.5;\"></i><p>Pilih gred jawatan untuk melihat gambar kuarters</p></div>';">
                `;
            }
            
            // Update class badge
            const previewKelas = document.getElementById('previewKelas');
            if (previewKelas) {
                previewKelas.textContent = kelasData.name;
                previewKelas.className = `kuarters-class-badge ${kelasData.color}`;
                previewKelas.style.backgroundColor = getColorForClass(kelas);
            }
            
            // Update details
            document.getElementById('previewGred').textContent = kelasData.gred.join(', ');
            document.getElementById('previewLuas').textContent = kelasData.luas;
            document.getElementById('previewBilik').textContent = kelasData.bilik;
            document.getElementById('previewKemudahan').textContent = kelasData.kemudahan;
            document.getElementById('previewSewa').textContent = kelasData.sewa;
            document.getElementById('previewLokasi').textContent = currentNegeri ? `Negeri: ${currentNegeri}` : '-';
            
            // Update status based on selected unit
            updatePreviewStatus(unitId, kelasData);
        }
        
        function getColorForClass(className) {
            switch(className) {
                case 'A': return '#9b59b6';
                case 'B': return '#3498db';
                case 'C': return '#2ecc71';
                case 'D': return '#e74c3c';
                default: return '#6c757d';
            }
        }
        
        function updatePreviewStatus(unitId = null, kelasData = null) {
            const statusElement = document.getElementById('previewStatus');
            const statusText = document.getElementById('statusText');
            
            if (!unitId || !kelasData) {
                if (statusElement) {
                    statusElement.className = 'availability-status';
                    const statusDot = statusElement.querySelector('.status-dot');
                    if (statusDot) statusDot.style.backgroundColor = '#6c757d';
                }
                if (statusText) statusText.textContent = 'Sila pilih unit';
                return;
            }
            
            const selectedUnit = kelasData.units.find(unit => unit.id === unitId);
            
            if (selectedUnit) {
                if (selectedUnit.status === 'available') {
                    statusElement.className = 'availability-status available';
                    statusElement.querySelector('.status-dot').style.backgroundColor = 'var(--success)';
                    statusText.textContent = 'Tersedia';
                    document.getElementById('previewLokasi').textContent = `${selectedUnit.lokasi}, ${selectedUnit.negeri}`;
                } else {
                    statusElement.className = 'availability-status occupied';
                    statusElement.querySelector('.status-dot').style.backgroundColor = 'var(--danger)';
                    statusText.textContent = 'Telah Ditempati';
                }
            } else {
                statusElement.className = 'availability-status';
                statusElement.querySelector('.status-dot').style.backgroundColor = '#6c757d';
                statusText.textContent = 'Tidak Dijumpai';
            }
        }
        
        function resetPreview() {
            const imageContainer = document.getElementById('kuartersImage');
            if (imageContainer) {
                imageContainer.innerHTML = `
                    <div class="image-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--gray); text-align: center; padding: 20px;">
                        <i class="fas fa-home" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Isi alamat jabatan dan pilih gred untuk melihat kuarters yang tersedia</p>
                    </div>
                `;
            }
            
            const previewKelas = document.getElementById('previewKelas');
            if (previewKelas) {
                previewKelas.textContent = '-';
                previewKelas.className = 'kuarters-class-badge';
                previewKelas.style.backgroundColor = '#6c757d';
            }
            
            document.getElementById('previewGred').textContent = '-';
            document.getElementById('previewLuas').textContent = '-';
            document.getElementById('previewBilik').textContent = '-';
            document.getElementById('previewKemudahan').textContent = '-';
            document.getElementById('previewSewa').textContent = '-';
            document.getElementById('previewLokasi').textContent = '-';
            
            const statusElement = document.getElementById('previewStatus');
            if (statusElement) {
                statusElement.className = 'availability-status';
                const statusDot = statusElement.querySelector('.status-dot');
                if (statusDot) statusDot.style.backgroundColor = '#6c757d';
                document.getElementById('statusText').textContent = '-';
            }
            
            document.getElementById('previewCount').textContent = 'Tiada unit ditemui';
            hideUnitsList();
        }
        
        function validateKuartersForm() {
            const requiredFields = [
                'namaPemohon', 'noKP', 'gredJawatan', 'jabatan',
                'alamatJabatan', 'tarikhMasuk', 'jarakKerja', 'justifikasi'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    alert(`Sila isi ${field.previousElementSibling.textContent}`);
                    field.focus();
                    return false;
                }
            }
            
            // Check if negeri detected
            if (!currentNegeri) {
                alert('Sila pastikan alamat jabatan mengandungi nama negeri (contoh: Kuala Lumpur, Selangor, Johor)');
                document.getElementById('alamatJabatan').focus();
                return false;
            }
            
            // Check radio buttons
            const maritalStatus = document.querySelector('input[name="statusPerkahwinan"]:checked');
            if (!maritalStatus) {
                alert('Sila pilih status perkahwinan');
                return false;
            }
            
            // Check jumlah tanggungan
            if (!document.getElementById('jumlahTanggungan').value) {
                alert('Sila pilih jumlah tanggungan');
                return false;
            }
            
            // Check unit kuarters
            const unitKuarters = document.getElementById('unitKuarters');
            if (!unitKuarters.value || unitKuarters.disabled) {
                alert('Sila pilih unit kuarters yang tersedia');
                return false;
            }
            
            // Validate tarikh masuk
            const tarikhMasuk = document.getElementById('tarikhMasuk').value;
            const today = new Date();
            const selectedDate = new Date(tarikhMasuk);
            
            if (selectedDate < today) {
                alert('Tarikh masuk tidak boleh kurang dari hari ini');
                document.getElementById('tarikhMasuk').value = '';
                return false;
            }
            
            return true;
        }
        
        function submitKuartersForm() {
            if (!validateKuartersForm()) return;
            
            // Show loading
            const spinner = document.getElementById('loadingSpinner');
            const submitBtn = document.getElementById('btnHantarKuarters');
            spinner.style.display = 'block';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                const selectedUnitId = document.getElementById('unitKuarters').value;
                const selectedUnit = availableUnits.find(unit => unit.id === selectedUnitId) || {};
                
                // Create application object
                const application = {
                    id: Date.now(),
                    reference: document.getElementById('noRujukan').textContent,
                    assetType: 'kuarters',
                    assetName: 'Kuarters Kakitangan',
                    applyDate: new Date().toISOString().split('T')[0],
                    applicantId: currentUser.id,
                    applicantName: currentUser.name,
                    nama: document.getElementById('namaPemohon').value,
                    noKP: document.getElementById('noKP').value,
                    gred: document.getElementById('gredJawatan').value,
                    jabatan: document.getElementById('jabatan').value,
                    alamatJabatan: document.getElementById('alamatJabatan').value,
                    negeri: currentNegeri,
                    statusPerkahwinan: document.querySelector('input[name="statusPerkahwinan"]:checked').value,
                    jumlahTanggungan: document.getElementById('jumlahTanggungan').value,
                    kelasKuarters: document.getElementById('kelasKuarters').value,
                    unitKuarters: selectedUnitId,
                    unitName: selectedUnit.name || '',
                    unitLokasi: selectedUnit.lokasi || '',
                    tarikhMasuk: document.getElementById('tarikhMasuk').value,
                    jarakKerja: document.getElementById('jarakKerja').value + ' km',
                    justifikasi: document.getElementById('justifikasi').value,
                    tarikhMohon: document.getElementById('tarikhMohon').value,
                    status: 'pending'
                };
                
                // Save application
                applications.push(application);
                localStorage.setItem(STORAGE_KEYS.APPLICATIONS, JSON.stringify(applications));
                
                // Update success modal
                document.getElementById('successRefNumber').textContent = application.reference;
                
                // Hide loading
                spinner.style.display = 'none';
                submitBtn.disabled = false;
                
                // Close kuarters modal and show success
                closeModal('borangKuartersModal');
                openModal('successModal');
                
                // Update applications list
                loadApplicationsList();
                
            }, 1500);
        }
        
        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        
        function setupEventListeners() {
            // Authentication
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            document.getElementById('goToRegister').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('register');
            });
            document.getElementById('goToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Navigation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.nav-links a')) {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    const page = link.dataset.page;
                    if (page) {
                        showPage(page + 'Page');
                    }
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Adakah anda pasti ingin log keluar?')) {
                    sessionStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    currentUser = null;
                    showAuthentication();
                }
            });
            
            // New application button
            document.getElementById('newApplicationBtn').addEventListener('click', function() {
                showPage('assetsPage');
            });
            
            // Apply buttons on asset cards
            document.addEventListener('click', function(e) {
                if (e.target.closest('.apply-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.apply-btn');
                    const modalId = btn.dataset.modal;
                    
                    if (modalId) {
                        openModal(modalId);
                    }
                }
            });
            
            // KUARTERS FORM EVENT LISTENERS
            // Detect negeri from address input
            const alamatJabatanInput = document.getElementById('alamatJabatan');
            if (alamatJabatanInput) {
                alamatJabatanInput.addEventListener('input', function() {
                    const alamat = this.value;
                    const negeri = detectNegeriFromAddress(alamat);
                    
                    if (negeri) {
                        currentNegeri = negeri;
                        document.getElementById('negeriDikesan').value = negeri;
                        
                        // Update unit options if gred sudah dipilih
                        const gred = document.getElementById('gredJawatan').value;
                        if (gred && GRED_TO_CLASS[gred]) {
                            const kelas = GRED_TO_CLASS[gred];
                            filterUnitsByNegeri(kelas, negeri);
                            document.getElementById('unitKuarters').disabled = false;
                        }
                    } else {
                        currentNegeri = '';
                        document.getElementById('negeriDikesan').value = 'Negeri tidak dapat dikesan';
                        document.getElementById('unitKuarters').disabled = true;
                        document.getElementById('unitKuarters').innerHTML = '<option value="">Sila masukkan alamat dengan negeri yang jelas</option>';
                        hideUnitsList();
                        document.getElementById('previewCount').textContent = 'Tiada unit ditemui';
                    }
                });
            }
            
            // Gred selection change
            const gredJawatanSelect = document.getElementById('gredJawatan');
            if (gredJawatanSelect) {
                gredJawatanSelect.addEventListener('change', function() {
                    updateKuartersClass();
                    if (currentNegeri) {
                        const gred = this.value;
                        if (gred && GRED_TO_CLASS[gred]) {
                            const kelas = GRED_TO_CLASS[gred];
                            filterUnitsByNegeri(kelas, currentNegeri);
                        }
                    }
                });
            }
            
            // Unit selection change
            const unitKuartersSelect = document.getElementById('unitKuarters');
            if (unitKuartersSelect) {
                unitKuartersSelect.addEventListener('change', function() {
                    updateKuartersPreview();
                    highlightSelectedUnit(this.value);
                });
            }
            
            // Refresh preview button
            const refreshPreviewBtn = document.getElementById('refreshPreview');
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', function() {
                    updateKuartersPreview(true);
                });
            }
            
            // Tarikh masuk validation
            const tarikhMasukInput = document.getElementById('tarikhMasuk');
            if (tarikhMasukInput) {
                tarikhMasukInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const today = new Date();
                    
                    if (selectedDate < today) {
                        alert('Tarikh masuk tidak boleh kurang dari hari ini');
                        this.value = '';
                    }
                });
            }
            
            // Submit kuarters form
            const btnHantarKuarters = document.getElementById('btnHantarKuarters');
            if (btnHantarKuarters) {
                btnHantarKuarters.addEventListener('click', submitKuartersForm);
            }
            
            // Batal kuarters form
            const btnBatalKuarters = document.getElementById('btnBatalKuarters');
            if (btnBatalKuarters) {
                btnBatalKuarters.addEventListener('click', function() {
                    closeModal('borangKuartersModal');
                });
            }
            
            // Close modal buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.dataset.modal;
                    if (modalId) {
                        closeModal(modalId);
                    }
                });
            });
            
            // Success modal OK button
            const btnOkSuccess = document.getElementById('btnOkSuccess');
            if (btnOkSuccess) {
                btnOkSuccess.addEventListener('click', function() {
                    closeModal('successModal');
                });
            }
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        }
        
        // Initialize system
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>
